<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Jornada - PredictHealth Doctor</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/doctor_dashboard.css') }}">
</head>
<body>
    <!-- Sidebar Navigation -->
    <nav class="main-menu" id="mainMenu">
        <div class="logo-container">
            <div class="logo-icon">
                <i class="fas fa-stethoscope"></i>
            </div>
            <div class="logo-text">PredictHealth</div>
        </div>

        <ul class="nav-menu">
            <li class="nav-item active" data-page="dashboard">
                <a href="#" onclick="loadPage('dashboard')">
                    <i class="fa fa-calendar-check nav-icon"></i>
                    <span class="nav-text">Mi Jornada</span>
                </a>
            </li>

            <li class="nav-item" data-page="patients">
                <a href="#" onclick="loadPage('patients')">
                    <i class="fa fa-users nav-icon"></i>
                    <span class="nav-text">Mis Pacientes</span>
                </a>
            </li>
        </ul>

        <div class="user-profile">
            <div class="user-info">
                <div class="user-avatar">
                    <i class="fas fa-user-md"></i>
                </div>
                <div class="user-details">
                    <div class="user-name" id="doctorName">Dr. Nombre</div>
                    <div class="user-role">Médico General</div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <section class="content" id="mainContent">
        <!-- Top Bar -->
        <div class="top-bar">
            <div class="patient-info">
                <span class="patient-name" id="doctorGreeting">Hola, Dr. Nombre</span>
                <span class="patient-type">Portal Médico</span>
            </div>
            <button class="logout-btn" onclick="handleLogout()">
                <i class="fas fa-sign-out-alt"></i>
                Cerrar Sesión
            </button>
        </div>

        <!-- Global Search Header -->
        <div class="global-search-header">
            <div class="search-container">
                <div class="search-input-wrapper">
                    <i class="fas fa-search search-icon"></i>
                    <input
                        type="text"
                        class="global-search-input"
                        id="globalSearch"
                        placeholder="Buscar paciente por nombre, apellido o ID..."
                        autocomplete="off"
                    >
                    <div class="search-results" id="searchResults"></div>
                </div>
            </div>
        </div>

        <!-- Dashboard Content -->
        <div class="dashboard-content">
            <div class="dashboard-grid">
                <!-- Appointments Timeline -->
                <div class="appointments-section">
                    <div class="section-header">
                        <h2 class="section-title">
                            <i class="fas fa-calendar-day me-2"></i>
                            Agenda del Día
                        </h2>
                        <button class="btn btn-primary" onclick="scheduleAppointment()">
                            <i class="fas fa-plus me-1"></i>
                            Nueva Cita
                        </button>
                    </div>

                    <div class="timeline" id="appointmentsTimeline">
                        <!-- Appointments will be loaded here -->
                    </div>
                </div>

                <!-- Tasks and Recent Patients Sidebar -->
                <div>
                    <!-- Pending Tasks -->
                    <div class="tasks-sidebar">
                        <h3 class="tasks-title">
                            <i class="fas fa-tasks"></i>
                            Tareas Pendientes
                        </h3>
                        <div id="pendingTasks">
                            <!-- Tasks will be loaded here -->
                        </div>
                    </div>

                    <!-- Recent Patients -->
                    <div class="tasks-sidebar recent-patients">
                        <h4 class="recent-title">Pacientes Recientes</h4>
                        <div id="recentPatients">
                            <!-- Recent patients will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Floating Add Button -->
    <button class="floating-add-btn" onclick="quickAddConsultation()" title="Registrar Nueva Consulta">
        <i class="fas fa-plus"></i>
    </button>

    <script>
        // Global variables
        let currentPage = 'dashboard';
        let appointments = [];
        let tasks = [];
        let recentPatients = [];
        let allPatients = [];
        let searchTimeout;

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            loadDoctorData();
            loadAppointments();
            loadTasks();
            loadRecentPatients();
            setupGlobalSearch();
            setupAutoLogout();
        });

        // Setup global search
        function setupGlobalSearch() {
            const searchInput = document.getElementById('globalSearch');
            const searchResults = document.getElementById('searchResults');

            searchInput.addEventListener('input', function(e) {
                const query = e.target.value.trim();

                if (query.length < 2) {
                    searchResults.style.display = 'none';
                    return;
                }

                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    performGlobalSearch(query);
                }, 300);
            });

            // Hide results when clicking outside
            document.addEventListener('click', function(e) {
                if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
                    searchResults.style.display = 'none';
                }
            });
        }

        // Perform global search
        async function performGlobalSearch(query) {
            try {
                const response = await fetch(`/api/web/doctor/search-patients?q=${encodeURIComponent(query)}`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include'
                });

                if (response.ok) {
                    const data = await response.json();
                    displaySearchResults(data.results || []);
                }
            } catch (error) {
                console.error('Error searching patients:', error);
            }
        }

        // Display search results
        function displaySearchResults(results) {
            const searchResults = document.getElementById('searchResults');

            if (results.length === 0) {
                searchResults.innerHTML = '<div class="search-result-item">No se encontraron pacientes</div>';
            } else {
                searchResults.innerHTML = results.map(patient => `
                    <div class="search-result-item" onclick="openPatientRecord('${patient.id_usuario}')">
                        <div class="result-name">${patient.nombre} ${patient.apellido}</div>
                        <div class="result-details">
                            ID: ${patient.id_usuario} • ${patient.email}
                        </div>
                    </div>
                `).join('');
            }

            searchResults.style.display = 'block';
        }

        // Load doctor data
        async function loadDoctorData() {
            try {
                const response = await fetch('/api/web/doctor/profile', {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include'
                });

                if (response.ok) {
                    const data = await response.json();
                    const doctorName = `Dr. ${data.doctor.nombre} ${data.doctor.apellido}`;
                    document.getElementById('doctorName').textContent = doctorName;

                    // Update greeting in top bar
                    const greetingElement = document.getElementById('doctorGreeting');
                    if (greetingElement) {
                        greetingElement.textContent = `Hola, ${doctorName}`;
                    }
                }
            } catch (error) {
                console.error('Error loading doctor data:', error);
            }
        }

        // Load appointments
        async function loadAppointments() {
            try {
                const response = await fetch('/api/web/doctor/appointments/today', {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include'
                });

                if (response.ok) {
                    const data = await response.json();
                    appointments = data.appointments || [];
                    displayAppointments();
                }
            } catch (error) {
                console.error('Error loading appointments:', error);
            }
        }

        // Display appointments timeline
        function displayAppointments() {
            const timeline = document.getElementById('appointmentsTimeline');
            const now = new Date();

            if (appointments.length === 0) {
                timeline.innerHTML = `
                    <div class="text-center py-5">
                        <i class="fas fa-calendar-times fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No hay citas programadas para hoy</h5>
                        <button class="btn btn-primary mt-3" onclick="scheduleAppointment()">
                            <i class="fas fa-plus me-1"></i>
                            Programar Primera Cita
                        </button>
                    </div>
                `;
                return;
            }

            timeline.innerHTML = appointments.map((appointment, index) => {
                const appointmentTime = new Date(`${new Date().toDateString()} ${appointment.hora}`);
                const isPast = appointmentTime < now;
                const isCurrent = !isPast && appointments[index - 1] &&
                    new Date(`${new Date().toDateString()} ${appointments[index - 1].hora}`) < now;

                return `
                    <div class="timeline-item ${isPast ? 'past' : ''} ${isCurrent ? 'current' : ''}">
                        <div class="appointment-card ${isPast ? 'past' : ''} ${isCurrent ? 'current' : ''}"
                             onclick="openPatientRecord('${appointment.id_paciente}')">
                            <div class="appointment-time">${appointment.hora}</div>
                            <div class="appointment-patient">${appointment.nombre_paciente}</div>
                            <div class="appointment-reason">${appointment.motivo || 'Consulta General'}</div>
                            <div class="appointment-actions">
                                <button class="btn-open-record" onclick="event.stopPropagation(); openPatientRecord('${appointment.id_paciente}')">
                                    <i class="fas fa-folder-open me-1"></i>
                                    Abrir Expediente
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Load pending tasks
        async function loadTasks() {
            try {
                const response = await fetch('/api/web/doctor/tasks/pending', {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include'
                });

                if (response.ok) {
                    const data = await response.json();
                    tasks = data.tasks || [];
                    displayTasks();
                }
            } catch (error) {
                console.error('Error loading tasks:', error);
            }
        }

        // Display tasks
        function displayTasks() {
            const tasksContainer = document.getElementById('pendingTasks');

            if (tasks.length === 0) {
                tasksContainer.innerHTML = `
                    <div class="text-center py-3">
                        <i class="fas fa-check-circle fa-2x text-success mb-2"></i>
                        <p class="text-muted small mb-0">No hay tareas pendientes</p>
                    </div>
                `;
                return;
            }

            tasksContainer.innerHTML = tasks.map(task => `
                <div class="task-item">
                    <input type="checkbox" class="task-checkbox" onchange="completeTask('${task.id}')">
                    <div class="task-content">
                        <div class="task-text">${task.descripcion}</div>
                        <div class="task-time">${formatTimeAgo(task.fecha_creacion)}</div>
                    </div>
                </div>
            `).join('');
        }

        // Load recent patients
        async function loadRecentPatients() {
            try {
                const response = await fetch('/api/web/doctor/patients/recent', {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include'
                });

                if (response.ok) {
                    const data = await response.json();
                    recentPatients = data.patients || [];
                    displayRecentPatients();
                }
            } catch (error) {
                console.error('Error loading recent patients:', error);
            }
        }

        // Display recent patients
        function displayRecentPatients() {
            const container = document.getElementById('recentPatients');

            if (recentPatients.length === 0) {
                container.innerHTML = '<p class="text-muted small">No hay pacientes recientes</p>';
                return;
            }

            container.innerHTML = recentPatients.map(patient => `
                <div class="recent-patient-item" onclick="openPatientRecord('${patient.id_usuario}')">
                    <div class="recent-patient-avatar">
                        ${patient.nombre.charAt(0)}${patient.apellido.charAt(0)}
                    </div>
                    <div class="recent-patient-info">
                        <div class="recent-patient-name">${patient.nombre} ${patient.apellido}</div>
                        <div class="recent-patient-last-visit">${formatTimeAgo(patient.ultima_visita)}</div>
                    </div>
                </div>
            `).join('');
        }

        // Setup auto-logout security
        function setupAutoLogout() {
            let inactivityTimer;
            const INACTIVITY_TIMEOUT = 15 * 60 * 1000; // 15 minutes

            function resetTimer() {
                clearTimeout(inactivityTimer);
                inactivityTimer = setTimeout(() => {
                    alert('Sesión expirada por inactividad. Serás redirigido al login.');
                    handleLogout();
                }, INACTIVITY_TIMEOUT);
            }

            // Reset timer on user activity
            ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart'].forEach(event => {
                document.addEventListener(event, resetTimer, true);
            });

            resetTimer();
        }

        // Utility functions
        function formatTimeAgo(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffInHours = Math.floor((now - date) / (1000 * 60 * 60));

            if (diffInHours < 1) return 'Hace menos de 1 hora';
            if (diffInHours === 1) return 'Hace 1 hora';
            if (diffInHours < 24) return `Hace ${diffInHours} horas`;

            const diffInDays = Math.floor(diffInHours / 24);
            if (diffInDays === 1) return 'Hace 1 día';
            return `Hace ${diffInDays} días`;
        }

        // Action functions
        function loadPage(page) {
            currentPage = page;

            // Update navigation active state
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`[data-page="${page}"]`).classList.add('active');

            // Handle page navigation
            switch(page) {
                case 'patients':
                    window.location.href = 'mis_pacientes.html';
                    break;
                case 'profile':
                    // Handle profile page
                    break;
            }
        }

        function openPatientRecord(patientId) {
            window.location.href = `/patient_record.html?id=${patientId}`;
        }

        function scheduleAppointment() {
            alert('Funcionalidad de programar cita próximamente disponible');
        }

        function quickAddConsultation() {
            alert('Funcionalidad de registrar consulta próximamente disponible');
        }

        async function completeTask(taskId) {
            try {
                const response = await fetch(`/api/web/doctor/tasks/${taskId}/complete`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include'
                });

                if (response.ok) {
                    loadTasks(); // Reload tasks
                }
            } catch (error) {
                console.error('Error completing task:', error);
            }
        }

        async function handleLogout() {
            try {
                await fetch('/auth/logout', {
                    method: 'POST',
                    credentials: 'include'
                });
            } catch (error) {
                console.error('Error during logout:', error);
            }
            window.location.href = '/';
        }
    </script>
</body>
</html>