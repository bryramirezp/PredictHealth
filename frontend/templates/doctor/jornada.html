{% extends "doctor/base_doctor.html" %}

{% block title %}Mi Jornada - PredictHealth Doctor{% endblock %}

{% block head_extra %}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            updateCurrentPage('Mi Jornada');
            loadDashboardData();
        });

        async function loadDashboardData() {
            showLoadingState();
            try {
                // Simulate API calls with dummy data
                setTimeout(() => {
                    animateNumber('today-appointments', 8);
                }, 500);

                setTimeout(() => {
                    animateNumber('total-patients', 156);
                }, 700);

                setTimeout(() => {
                    animateNumber('completed-consultations', 23);
                }, 900);

                setTimeout(() => {
                    animateNumber('urgent-cases', 2);
                }, 1100);

                loadDoctors(); // Load schedule data
                hideLoadingState();
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                showErrorState();
            }
        }

        function animateNumber(elementId, targetNumber) {
            const element = document.getElementById(elementId);
            if (!element) return;

            const duration = 2000;
            const startTime = performance.now();
            const startNumber = 0;

            function updateNumber(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const easeOutQuart = 1 - Math.pow(1 - progress, 4);
                const currentNumber = Math.floor(startNumber + (targetNumber - startNumber) * easeOutQuart);

                element.textContent = currentNumber;

                if (progress < 1) {
                    requestAnimationFrame(updateNumber);
                }
            }

            requestAnimationFrame(updateNumber);
        }

        function loadDoctors() {
            const scheduleTimeline = document.getElementById('scheduleTimeline');
            if (!scheduleTimeline) return;

            // Dummy appointments data
            const appointments = [
                { time: '09:00', patient: 'Ana López', reason: 'Chequeo General', status: 'current' },
                { time: '10:30', patient: 'Carlos Rodríguez', reason: 'Dolor de cabeza', status: 'scheduled' },
                { time: '11:15', patient: 'María González', reason: 'Presión alta', status: 'scheduled' },
                { time: '12:00', patient: 'Juan Pérez', reason: 'Diabetes', status: 'scheduled' },
                { time: '14:30', patient: 'Rosa Martínez', reason: 'Consulta prenatal', status: 'scheduled' }
            ];

            scheduleTimeline.innerHTML = appointments.map(appointment => `
                <div class="appointment-card ${appointment.status === 'current' ? 'current' : ''}">
                    <div class="appointment-time">${appointment.time}</div>
                    <div class="appointment-patient">${appointment.patient}</div>
                    <div class="appointment-reason">${appointment.reason}</div>
                    <div class="appointment-actions">
                        <button class="btn-open-record" onclick="openPatientRecord('${appointment.patient.replace(' ', '_')}')">
                            <i class="fas fa-folder-open me-1"></i>
                            Ver Expediente
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Override base_doctor.html's refreshData for this page
        window.refreshData = function() {
            loadDashboardData();
        }
    </script>
{% endblock %}

{% block breadcrumb %}Mi Jornada{% endblock %}

{% block content %}
    <div id="pageContent" class="page-content">
        <!-- Welcome Section -->
        <div class="welcome-section">
            <h1 class="welcome-title" id="welcomeTitle">Mi Jornada Médica</h1>
            <p class="welcome-subtitle" id="welcomeSubtitle">Gestión integral de pacientes y consultas</p>
        </div>

        <!-- Stats Grid -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-icon appointments">
                        <i class="fas fa-calendar-check"></i>
                    </div>
                    <div class="stat-menu">
                        <i class="fas fa-ellipsis-h" onclick="showStatMenu('appointments')"></i>
                    </div>
                </div>
                <div class="stat-number" id="today-appointments">--</div>
                <div class="stat-label">Citas Hoy</div>
                <div class="stat-trend positive" id="appointments-trend">
                    <i class="fas fa-arrow-up"></i>
                    <span>+3 programadas</span>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-icon patients">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="stat-menu">
                        <i class="fas fa-ellipsis-h" onclick="showStatMenu('patients')"></i>
                    </div>
                </div>
                <div class="stat-number" id="total-patients">--</div>
                <div class="stat-label">Pacientes Totales</div>
                <div class="stat-trend positive" id="patients-trend">
                    <i class="fas fa-arrow-up"></i>
                    <span>+8 esta semana</span>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-icon completed">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="stat-menu">
                        <i class="fas fa-ellipsis-h" onclick="showStatMenu('completed')"></i>
                    </div>
                </div>
                <div class="stat-number" id="completed-consultations">--</div>
                <div class="stat-label">Consultas Completadas</div>
                <div class="stat-trend positive" id="completed-trend">
                    <i class="fas fa-arrow-up"></i>
                    <span>+12 esta semana</span>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-icon urgent">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                </div>
                <div class="stat-number" id="urgent-cases">--</div>
                <div class="stat-label">Casos Urgentes</div>
                <div class="stat-trend warning" id="urgent-trend">
                    <i class="fas fa-minus"></i>
                    <span>2 pendientes</span>
                </div>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="main-content">
            <!-- Left Content -->
            <div class="left-content">
                <!-- Today's Schedule -->
                <div class="schedule-section">
                    <h2 class="section-title">
                        <i class="fas fa-calendar-day"></i>
                        Agenda del Día
                    </h2>
                    <div class="schedule-timeline" id="scheduleTimeline">
                        <!-- Appointments will be loaded here -->
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="quick-actions">
                    <h2 class="section-title">
                        <i class="fas fa-bolt"></i>
                        Acciones Rápidas
                    </h2>
                    <div class="actions-grid">
                        <a href="#" onclick="scheduleAppointment()" class="action-card">
                            <div class="action-icon schedule-appointment">
                                <i class="fas fa-calendar-plus"></i>
                            </div>
                            <div class="action-content">
                                <h3>Nueva Cita</h3>
                                <p>Programar consulta médica</p>
                            </div>
                        </a>

                        <a href="#" onclick="addConsultation()" class="action-card">
                            <div class="action-icon add-consultation">
                                <i class="fas fa-stethoscope"></i>
                            </div>
                            <div class="action-content">
                                <h3>Registrar Consulta</h3>
                                <p>Agregar nueva evaluación</p>
                            </div>
                        </a>

                        <a href="#" onclick="viewReports()" class="action-card">
                            <div class="action-icon medical-reports">
                                <i class="fas fa-file-medical"></i>
                            </div>
                            <div class="action-content">
                                <h3>Reportes Médicos</h3>
                                <p>Generar informes clínicos</p>
                            </div>
                        </a>

                        <a href="#" onclick="emergencyAlert()" class="action-card">
                            <div class="action-icon emergency">
                                <i class="fas fa-ambulance"></i>
                            </div>
                            <div class="action-content">
                                <h3>Alerta Médica</h3>
                                <p>Casos de emergencia</p>
                            </div>
                        </a>
                    </div>
                </div>
            </div>

            <!-- Right Content -->
            <div class="right-content">
                <!-- Pending Tasks -->
                <div class="pending-tasks">
                    <h3 class="section-title">
                        <i class="fas fa-tasks"></i>
                        Tareas Pendientes
                    </h3>
                    <div class="tasks-list" id="pendingTasks">
                        <!-- Tasks will be loaded here -->
                    </div>
                </div>

                <!-- Recent Patients -->
                <div class="recent-patients">
                    <h3 class="section-title">
                        <i class="fas fa-clock"></i>
                        Pacientes Recientes
                    </h3>
                    <div class="patients-list" id="recentPatients">
                        <!-- Recent patients will be loaded here -->
                    </div>
                </div>

                <!-- Health Metrics -->
                <div class="health-metrics">
                    <h3 class="section-title">
                        <i class="fas fa-heartbeat"></i>
                        Indicadores de Salud
                    </h3>
                    <div class="metrics-grid">
                        <div class="metric-item">
                            <div class="metric-value">94%</div>
                            <div class="metric-label">Satisfacción Pacientes</div>
                            <div class="metric-change positive">+5.2%</div>
                        </div>

                        <div class="metric-item">
                            <div class="metric-value">12min</div>
                            <div class="metric-label">Tiempo Consulta Promedio</div>
                            <div class="metric-change negative">-2min</div>
                        </div>

                        <div class="metric-item">
                            <div class="metric-value">98%</div>
                            <div class="metric-label">Tasa Recuperación</div>
                            <div class="metric-change positive">+1.8%</div>
                        </div>
                    </div>
                </div>

                <!-- Global Search -->
                <div class="global-search-widget">
                    <h3 class="section-title">
                        <i class="fas fa-search"></i>
                        Búsqueda Global
                    </h3>
                    <div class="search-widget">
                        <div class="search-input-wrapper">
                            <input
                                type="text"
                                class="global-search-input"
                                id="globalSearch"
                                placeholder="Buscar paciente..."
                                autocomplete="off"
                            >
                            <i class="fas fa-search search-icon"></i>
                        </div>
                        <div class="search-results" id="searchResults" style="display: none;">
                            <!-- Search results will appear here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}