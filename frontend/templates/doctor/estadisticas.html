{% extends "doctor/base_doctor.html" %}

{% block title %}Estadísticas - PredictHealth Doctor{% endblock %}

{% block head_extra %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            updateCurrentPage('Estadísticas');
            loadAnalyticsData();
        });

        function loadAnalyticsData() {
            showLoadingState();
            // Simulate API calls with dummy data
            setTimeout(() => {
                renderAgeChart();
                renderConsultationsChart();
                renderSpecialtiesChart();
                renderRiskChart();
                hideLoadingState();
            }, 500);
        }

        function renderAgeChart() {
            const ctx = document.getElementById('ageChart').getContext('2d');
            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['18-24', '25-34', '35-44', '45-54', '55+'],
                    datasets: [{
                        data: [15, 25, 30, 20, 10],
                        backgroundColor: ['#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b'],
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: 'Distribución de Pacientes por Edad'
                        }
                    }
                }
            });
        }

        function renderConsultationsChart() {
            const ctx = document.getElementById('consultationsChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun'],
                    datasets: [{
                        label: 'Consultas',
                        data: [12, 19, 3, 5, 2, 3],
                        backgroundColor: 'rgba(78, 115, 223, 0.05)',
                        borderColor: 'rgba(78, 115, 223, 1)',
                        borderWidth: 3,
                        pointRadius: 3,
                        pointBackgroundColor: 'rgba(78, 115, 223, 1)',
                        pointBorderColor: 'rgba(78, 115, 223, 1)',
                        pointHoverRadius: 3,
                        pointHoverBackgroundColor: 'rgba(78, 115, 223, 1)',
                        pointHoverBorderColor: 'rgba(78, 115, 223, 1)',
                        pointHitRadius: 10,
                        pointBorderWidth: 2,
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: true,
                            text: 'Consultas Mensuales'
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: "rgb(234, 236, 244)",
                                zeroLineColor: "rgb(234, 236, 244)",
                                drawBorder: false,
                                borderDash: [2],
                                zeroLineBorderDash: [2]
                            }
                        }
                    }
                }
            });
        }

        function renderSpecialtiesChart() {
            const ctx = document.getElementById('specialtiesChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['General', 'Cardiología', 'Neurología', 'Pediatría', 'Dermatología'],
                    datasets: [{
                        label: 'Pacientes',
                        data: [50, 20, 15, 10, 5],
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.8)',
                            'rgba(54, 162, 235, 0.8)',
                            'rgba(255, 206, 86, 0.8)',
                            'rgba(75, 192, 192, 0.8)',
                            'rgba(153, 102, 255, 0.8)'
                        ],
                        borderColor: [
                            'rgba(255, 99, 132, 1)',
                            'rgba(54, 162, 235, 1)',
                            'rgba(255, 206, 86, 1)',
                            'rgba(75, 192, 192, 1)',
                            'rgba(153, 102, 255, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: true,
                            text: 'Pacientes por Especialidad'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function renderRiskChart() {
            const ctx = document.getElementById('riskChart').getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Bajo', 'Medio', 'Alto', 'Crítico'],
                    datasets: [{
                        data: [60, 25, 10, 5],
                        backgroundColor: ['#1cc88a', '#f6c23e', '#e74a3b', '#858796'],
                        hoverBackgroundColor: ['#17a673', '#f4b619', '#e03b2c', '#6e707e'],
                        hoverBorderColor: "rgba(234, 236, 244, 1)",
                    }],
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        title: {
                            display: true,
                            text: 'Evaluación de Riesgos de Pacientes'
                        }
                    }
                },
            });
        }

        function exportAnalytics() {
            alert('Funcionalidad de exportación de estadísticas próximamente disponible');
        }

        // Override base_doctor.html's refreshData for this page
        window.refreshData = function() {
            loadAnalyticsData();
        }
    </script>
{% endblock %}

{% block breadcrumb %}Estadísticas{% endblock %}

{% block content %}
    <div id="pageContent" class="page-content">
        <div class="section-header">
            <div class="section-info">
                <h1 class="section-title">Estadísticas Médicas</h1>
                <p class="section-subtitle">Análisis detallado de tu práctica médica</p>
            </div>
            <div class="section-actions">
                <div class="filter-group">
                    <select id="analyticsPeriod" class="filter-select">
                        <option value="7">Última semana</option>
                        <option value="30">Último mes</option>
                        <option value="90">Últimos 3 meses</option>
                        <option value="365">Último año</option>
                    </select>
                    <button class="btn btn-outline-primary" onclick="exportAnalytics()">
                        <i class="fas fa-download me-2"></i>
                        Exportar
                    </button>
                </div>
            </div>
        </div>

        <!-- Analytics Grid -->
        <div class="analytics-grid">
            <!-- Patient Distribution -->
            <div class="chart-card">
                <div class="chart-header">
                    <h3 class="chart-title">
                        <i class="fas fa-chart-pie"></i>
                        Distribución por Edad
                    </h3>
                </div>
                <div class="chart-container">
                    <canvas id="ageChart"></canvas>
                </div>
            </div>

            <!-- Consultations Chart -->
            <div class="chart-card">
                <div class="chart-header">
                    <h3 class="chart-title">
                        <i class="fas fa-chart-line"></i>
                        Consultas Mensuales
                    </h3>
                </div>
                <div class="chart-container">
                    <canvas id="consultationsChart"></canvas>
                </div>
            </div>

            <!-- Specialties Chart -->
            <div class="chart-card">
                <div class="chart-header">
                    <h3 class="chart-title">
                        <i class="fas fa-stethoscope"></i>
                        Especialidades Tratadas
                    </h3>
                </div>
                <div class="chart-container">
                    <canvas id="specialtiesChart"></canvas>
                </div>
            </div>

            <!-- Risk Assessment -->
            <div class="chart-card">
                <div class="chart-header">
                    <h3 class="chart-title">
                        <i class="fas fa-exclamation-triangle"></i>
                        Evaluación de Riesgos
                    </h3>
                </div>
                <div class="chart-container">
                    <canvas id="riskChart"></canvas>
                </div>
            </div>
        </div>

        <!-- KPIs Section -->
        <div class="kpis-section">
            <h3 class="section-title">Indicadores Clave de Rendimiento</h3>
            <div class="kpis-grid">
                <div class="kpi-item">
                    <div class="kpi-value">96.2%</div>
                    <div class="kpi-label">Tasa de Ocupación</div>
                    <div class="kpi-change positive">+2.1%</div>
                </div>

                <div class="kpi-item">
                    <div class="kpi-value">15min</div>
                    <div class="kpi-label">Tiempo Promedio Consulta</div>
                    <div class="kpi-change negative">-1.5min</div>
                </div>

                <div class="kpi-item">
                    <div class="kpi-value">$180</div>
                    <div class="kpi-label">Ingreso por Consulta</div>
                    <div class="kpi-change positive">+12.3%</div>
                </div>

                <div class="kpi-item">
                    <div class="kpi-value">4.9/5</div>
                    <div class="kpi-label">Calificación Promedio</div>
                    <div class="kpi-change positive">+0.3</div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}