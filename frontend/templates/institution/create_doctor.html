{% extends "institution/base_institution.html" %}

{% block title %}Crear Doctor - PredictHealth Instituci√≥n{% endblock %}

{% block page_title %}Crear Nuevo Doctor{% endblock %}
{% block page_subtitle %}Registra un nuevo profesional m√©dico en tu instituci√≥n{% endblock %}

{% block current_page %}doctors{% endblock %}

{% block head_extra %}{% endblock %}

{% block content %}
<div class="create-doctor-content">
    <div class="form-container">
        <h2 class="form-title">üè• Crear Nuevo Doctor</h2>

        <div class="instructions">
            <h4>Instrucciones para crear doctor</h4>
            <ol>
                <li>Aseg√∫rate de estar logueado como instituci√≥n</li>
                <li>Completa todos los campos requeridos marcados con *</li>
                <li>El doctor ser√° creado y asociado autom√°ticamente a tu instituci√≥n</li>
                <li>Se enviar√° un email de confirmaci√≥n al doctor creado</li>
            </ol>
        </div>

        <div id="alert" class="alert"></div>

        <form id="doctorForm" action="{{ url_for('web.institution_create_doctor') }}" method="POST">
            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label" for="nombre">Nombre *</label>
                    <input type="text" id="nombre" name="nombre" class="form-input" required>
                </div>

                <div class="form-group">
                    <label class="form-label" for="apellido">Apellido *</label>
                    <input type="text" id="apellido" name="apellido" class="form-input" required>
                </div>

                <div class="form-group">
                    <label class="form-label" for="email">Email *</label>
                    <input type="email" id="email" name="email" class="form-input" required>
                </div>

                <div class="form-group">
                    <label class="form-label" for="licencia_medica">Licencia M√©dica *</label>
                    <input type="text" id="licencia_medica" name="licencia_medica" class="form-input" required>
                </div>

                <div class="form-group">
                    <label class="form-label" for="especialidad">Especialidad</label>
                    <input type="text" id="especialidad" name="especialidad" class="form-input"
                           placeholder="Ej: Cardiolog√≠a, Neurolog√≠a, Pediatr√≠a, etc.">
                </div>

                <div class="form-group">
                    <label class="form-label" for="telefono">Tel√©fono</label>
                    <input type="tel" id="telefono" name="telefono" class="form-input"
                           placeholder="+52 55 1234 5678">
                </div>

                <div class="form-group full-width">
                    <label class="form-label" for="password">Contrase√±a *</label>
                    <input type="password" id="password" name="password" class="form-input"
                           required minlength="8" placeholder="M√≠nimo 8 caracteres">
                </div>

                <div class="form-group full-width">
                    <label class="form-label" for="confirm_password">Confirmar Contrase√±a *</label>
                    <input type="password" id="confirm_password" name="confirm_password"
                           class="form-input" required minlength="8">
                </div>
            </div>

            <div class="form-actions">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-user-plus"></i>
                    Crear Doctor
                </button>
                <a href="{{ url_for('web.institution_get_doctors') }}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i>
                    Cancelar
                </a>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts_extra %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('doctorForm');
    const alertDiv = document.getElementById('alert');

    form.addEventListener('submit', function(e) {
        e.preventDefault();

        // Validate passwords match
        const password = document.getElementById('password').value;
        const confirmPassword = document.getElementById('confirm_password').value;

        if (password !== confirmPassword) {
            showAlert('Las contrase√±as no coinciden', 'error');
            return;
        }

        const formData = new FormData(this);

        fetch('/api/web/institution/doctors', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (response.ok) {
                showAlert('¬°Doctor creado exitosamente! Se ha enviado un email de confirmaci√≥n.', 'success');
                form.reset();
                // Redirect after success
                setTimeout(() => {
                    window.location.href = '{{ url_for("web.institution_get_doctors") }}';
                }, 2000);
            } else {
                return response.json().then(data => {
                    showAlert('Error al crear doctor: ' + (data.message || 'Error desconocido'), 'error');
                });
            }
        })
        .catch(error => {
            showAlert('Error de conexi√≥n: ' + error.message, 'error');
        });
    });

    // Password confirmation validation
    document.getElementById('confirm_password').addEventListener('input', function() {
        const password = document.getElementById('password').value;
        const confirmPassword = this.value;

        if (confirmPassword && password !== confirmPassword) {
            this.setCustomValidity('Las contrase√±as no coinciden');
        } else {
            this.setCustomValidity('');
        }
    });
});

function showAlert(message, type) {
    const alertDiv = document.getElementById('alert');
    alertDiv.textContent = message;
    alertDiv.className = `alert alert-${type}`;
    alertDiv.style.display = 'block';

    setTimeout(() => {
        alertDiv.style.display = 'none';
    }, 5000);
}
</script>
{% endblock %}
