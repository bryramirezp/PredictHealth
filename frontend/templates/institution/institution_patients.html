{% extends "institution/base_institution.html" %}

{% block title %}Pacientes - PredictHealth Institución{% endblock %}

{% block page_title %}Pacientes{% endblock %}
{% block page_subtitle %}Revisa los pacientes atendidos por los doctores de tu institución{% endblock %}

{% block current_page %}patients{% endblock %}

{% block head_extra %}{% endblock %}

{% block content %}

        <!-- Patients Content -->
        <div class="patients-content">
            <!-- Statistics -->
            <div class="patients-stats">
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon patients">
                            <i class="fas fa-users"></i>
                        </div>
                    </div>
                    <div class="stat-number" id="totalPatients">0</div>
                    <div class="stat-label">Total Pacientes</div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon active">
                            <i class="fas fa-check-circle"></i>
                        </div>
                    </div>
                    <div class="stat-number" id="activePatients">0</div>
                    <div class="stat-label">Pacientes Activos</div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon high-risk">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                    </div>
                    <div class="stat-number" id="highRiskPatients">0</div>
                    <div class="stat-label">Alto Riesgo</div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon new">
                            <i class="fas fa-user-plus"></i>
                        </div>
                    </div>
                    <div class="stat-number" id="newPatients">0</div>
                    <div class="stat-label">Nuevos este Mes</div>
                </div>
            </div>

            <!-- Patients Table -->
            <div class="patients-table">
                <h3 class="mb-3" style="padding: 1rem 1rem 0 1rem; margin: 0; font-size: 1.1rem; font-weight: 600; color: var(--text-primary);">
                    <i class="fas fa-list me-2"></i>
                    Lista de Pacientes
                </h3>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Paciente</th>
                                <th>Doctor Asignado</th>
                                <th>Última Visita</th>
                                <th>Riesgo</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="patientsTableBody">
                            <!-- Patients will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </section>

{% endblock %}

{% block scripts_extra %}
<script>
        // Global variables
        let institutionData = {};

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadInstitutionData();
            loadPatients();
        });

        // Toggle sidebar
        function toggleSidebar() {
            const menu = document.getElementById('mainMenu');
            const content = document.getElementById('mainContent');

            menu.classList.toggle('collapsed');
            content.classList.toggle('expanded');
        }

        // Load institution data
        async function loadInstitutionData() {
            try {
                const response = await fetch('/api/web/institution/dashboard', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include'
                });

                if (response.ok) {
                    const data = await response.json();
                    institutionData = data.data || {};

                    // Update UI with institution data
                    updateInstitutionInfo(institutionData);
                } else if (response.status === 401) {
                    window.location.href = '/institution_login.html';
                }
            } catch (error) {
                console.error('Error loading institution data:', error);
            }
        }

        // Update institution information in UI
        function updateInstitutionInfo(data) {
            if (data.institution) {
                document.getElementById('userName').textContent = data.institution.nombre || 'Institución';
                document.getElementById('institutionType').textContent = data.institution.tipo_institucion || 'Institución';
            }
        }

        // Load patients data
        async function loadPatients() {
            try {
                const response = await fetch('/api/web/institution/patients', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include'
                });

                if (response.ok) {
                    const data = await response.json();
                    displayPatients(data.patients || []);
                    updatePatientStats(data.stats || {});
                } else {
                    displayPatients([]);
                }
            } catch (error) {
                console.error('Error loading patients:', error);
                displayPatients([]);
            }
        }

        // Display patients
        function displayPatients(patients) {
            const tableBody = document.getElementById('patientsTableBody');

            if (patients.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-5">
                            <i class="fas fa-users fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">No hay pacientes registrados</h5>
                            <p class="text-muted">Los pacientes aparecerán aquí cuando los doctores los registren</p>
                        </td>
                    </tr>
                `;
                return;
            }

            tableBody.innerHTML = patients.map(patient => {
                const initials = `${patient.nombre.charAt(0)}${patient.apellido.charAt(0)}`;
                const riskLevel = getRiskLevel(patient.risk_score);
                const riskClass = `risk-${riskLevel.toLowerCase()}`;
                const statusClass = patient.estado_validacion === 'full_access' ? 'active' : 'inactive';
                const statusText = getStatusText(patient.estado_validacion);

                return `
                    <tr>
                        <td>
                            <div class="patient-info">
                                <div class="patient-avatar">${initials}</div>
                                <div>
                                    <div class="patient-name">${patient.nombre} ${patient.apellido}</div>
                                    <div class="patient-email">${patient.email}</div>
                                </div>
                            </div>
                        </td>
                        <td>${patient.doctor_name || 'Sin asignar'}</td>
                        <td>${formatDate(patient.ultima_visita) || 'N/A'}</td>
                        <td><span class="risk-badge ${riskClass}">${riskLevel}</span></td>
                        <td><span class="status-badge status-${statusClass}">${statusText}</span></td>
                        <td>
                            <button class="btn btn-outline-primary" onclick="viewPatient('${patient.id_usuario}')">
                                <i class="fas fa-eye"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Update patient statistics
        function updatePatientStats(stats) {
            document.getElementById('totalPatients').textContent = stats.total_patients || 0;
            document.getElementById('activePatients').textContent = stats.active_patients || 0;
            document.getElementById('highRiskPatients').textContent = stats.high_risk || 0;
            document.getElementById('newPatients').textContent = stats.new_this_month || 0;
        }

        // Utility functions
        function getRiskLevel(score) {
            if (score >= 70) return 'Alto';
            if (score >= 40) return 'Medio';
            return 'Bajo';
        }

        function getStatusText(status) {
            switch(status) {
                case 'full_access': return 'Activo';
                case 'institution_validated': return 'Validado';
                case 'doctor_validated': return 'En Revisión';
                case 'pending': return 'Pendiente';
                default: return 'Desconocido';
            }
        }

        function formatDate(dateString) {
            if (!dateString) return null;
            const date = new Date(dateString);
            return date.toLocaleDateString('es-ES');
        }

        // Action functions
        function viewPatient(patientId) {
            alert('Funcionalidad de ver paciente próximamente disponible');
        }

        // Handle logout
        async function handleLogout() {
            if (confirm('¿Estás seguro de que quieres cerrar sesión?')) {
                try {
                    const response = await fetch('/auth/logout', {
                        method: 'POST',
                        credentials: 'include'
                    });

                    if (response.ok) {
                        window.location.href = '/';
                    } else {
                        console.error('Error en logout:', response.status);
                        alert('Error al cerrar sesión. Inténtalo de nuevo.');
                    }
                } catch (error) {
                    console.error('Error de conexión en logout:', error);
                    alert('Error de conexión. Inténtalo de nuevo.');
                }
            }
        }

        // Handle window resize for responsive sidebar
        window.addEventListener('resize', function() {
            if (window.innerWidth <= 768) {
                const menu = document.getElementById('mainMenu');
                const content = document.getElementById('mainContent');

                menu.classList.add('collapsed');
                content.classList.add('expanded');
            }
        });
</script>
{% endblock %}
