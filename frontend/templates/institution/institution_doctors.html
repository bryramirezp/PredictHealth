{% extends "institution/base_institution.html" %}

{% block title %}Gestión de Doctores - PredictHealth Institución{% endblock %}

{% block page_title %}Gestión de Doctores{% endblock %}
{% block page_subtitle %}Administra los doctores de tu institución{% endblock %}

{% block current_page %}doctors{% endblock %}

{% block head_extra %}{% endblock %}

{% block content %}

        <!-- Doctors Content -->
        <div class="doctors-content">
            <div class="doctors-header">
                <div></div>
                <button class="btn btn-primary" onclick="showAddDoctorModal()">
                    <i class="fas fa-plus"></i>
                    Agregar Doctor
                </button>
            </div>

            <!-- Statistics -->
            <div class="doctors-stats">
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon doctors">
                            <i class="fas fa-user-md"></i>
                        </div>
                    </div>
                    <div class="stat-number" id="totalDoctors">0</div>
                    <div class="stat-label">Total Doctores</div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon active">
                            <i class="fas fa-check-circle"></i>
                        </div>
                    </div>
                    <div class="stat-number" id="activeDoctors">0</div>
                    <div class="stat-label">Doctores Activos</div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon inactive">
                            <i class="fas fa-pause-circle"></i>
                        </div>
                    </div>
                    <div class="stat-number" id="inactiveDoctors">0</div>
                    <div class="stat-label">Doctores Inactivos</div>
                </div>
            </div>

            <!-- Doctors Grid -->
            <div class="doctors-grid" id="doctorsGrid">
                <!-- Doctors will be loaded here -->
            </div>
        </div>
    </section>

{% endblock %}

{% block scripts_extra %}
<script>
        // Global variables
        let institutionData = {};

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadInstitutionData();
            loadDoctors();
        });

        // Toggle sidebar
        function toggleSidebar() {
            const menu = document.getElementById('mainMenu');
            const content = document.getElementById('mainContent');

            menu.classList.toggle('collapsed');
            content.classList.toggle('expanded');
        }

        // Load institution data
        async function loadInstitutionData() {
            try {
                const response = await fetch('/api/web/institution/dashboard', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include'
                });

                if (response.ok) {
                    const data = await response.json();
                    institutionData = data.data || {};

                    // Update UI with institution data
                    updateInstitutionInfo(institutionData);
                } else if (response.status === 401) {
                    window.location.href = '/institution_login.html';
                }
            } catch (error) {
                console.error('Error loading institution data:', error);
            }
        }

        // Update institution information in UI
        function updateInstitutionInfo(data) {
            if (data.institution) {
                document.getElementById('userName').textContent = data.institution.nombre || 'Institución';
                document.getElementById('institutionType').textContent = data.institution.tipo_institucion || 'Institución';
            }
        }

        // Load doctors data
        async function loadDoctors() {
            try {
                const response = await fetch('/api/web/institution/doctors', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include'
                });

                const data = await response.json();

                if (response.ok && data.status === 'success') {
                    displayDoctors(data.doctors || []);
                    updateDoctorStats(data.stats || {});
                } else {
                    displayDoctors([]);
                }
            } catch (error) {
                console.error('Error loading doctors:', error);
                displayDoctors([]);
            }
        }

        // Display doctors
        function displayDoctors(doctors) {
            const doctorsGrid = document.getElementById('doctorsGrid');

            if (doctors.length === 0) {
                doctorsGrid.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">
                            <i class="fas fa-user-md"></i>
                        </div>
                        <h3 class="empty-title">No hay doctores registrados</h3>
                        <p class="empty-description">
                            Comienza agregando el primer doctor a tu institución
                        </p>
                        <button class="btn btn-primary" onclick="showAddDoctorModal()">
                            <i class="fas fa-plus"></i>
                            Agregar Primer Doctor
                        </button>
                    </div>
                `;
                return;
            }

            doctorsGrid.innerHTML = doctors.map(doctor => {
                const initials = doctor.nombre ? doctor.nombre.charAt(0) + (doctor.apellido ? doctor.apellido.charAt(0) : '') : 'DR';
                const statusClass = doctor.activo ? 'active' : 'inactive';
                const statusText = doctor.activo ? 'Activo' : 'Inactivo';

                return `
                    <div class="doctor-card">
                        <div class="doctor-header">
                            <div class="doctor-avatar">${initials}</div>
                            <div class="doctor-info">
                                <h3>Dr. ${doctor.nombre || 'Nombre'} ${doctor.apellido || 'Apellido'}</h3>
                                <p>${doctor.email || 'email@ejemplo.com'}</p>
                                <p>ID: ${doctor.id_doctor || doctor.id || 'N/A'}</p>
                            </div>
                        </div>
                        <div class="doctor-specialty">${doctor.especialidad || doctor.specialty || 'Sin especialidad'}</div>
                        <div class="doctor-status ${statusClass}">
                            <i class="fas fa-circle"></i>
                            ${statusText}
                        </div>
                        <div class="doctor-actions">
                            <button class="btn btn-outline-primary" onclick="viewDoctor('${doctor.id_doctor || doctor.id}')">
                                <i class="fas fa-eye"></i>
                                Ver Perfil
                            </button>
                            <button class="btn btn-outline-danger" onclick="deleteDoctor('${doctor.id_doctor || doctor.id}', '${doctor.nombre || 'Doctor'}')">
                                <i class="fas fa-trash"></i>
                                Eliminar
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Update doctor statistics
        function updateDoctorStats(stats) {
            document.getElementById('totalDoctors').textContent = stats.total_doctors || 0;
            document.getElementById('activeDoctors').textContent = stats.active_doctors || 0;
            document.getElementById('inactiveDoctors').textContent = stats.inactive_doctors || 0;
        }

        // Action functions
        function showAddDoctorModal() {
            alert('Funcionalidad de agregar doctor próximamente disponible');
        }

        function viewDoctor(doctorId) {
            alert('Funcionalidad de ver perfil próximamente disponible');
        }

        function deleteDoctor(doctorId, doctorName) {
            if (confirm(`¿Estás seguro de que deseas eliminar al Dr. ${doctorName}?`)) {
                alert('Funcionalidad de eliminar doctor próximamente disponible');
            }
        }

        // Handle logout
        async function handleLogout() {
            if (confirm('¿Estás seguro de que quieres cerrar sesión?')) {
                try {
                    const response = await fetch('/auth/logout', {
                        method: 'POST',
                        credentials: 'include'
                    });

                    if (response.ok) {
                        window.location.href = '/';
                    } else {
                        console.error('Error en logout:', response.status);
                        alert('Error al cerrar sesión. Inténtalo de nuevo.');
                    }
                } catch (error) {
                    console.error('Error de conexión en logout:', error);
                    alert('Error de conexión. Inténtalo de nuevo.');
                }
            }
        }

        // Handle window resize for responsive sidebar
        window.addEventListener('resize', function() {
            if (window.innerWidth <= 768) {
                const menu = document.getElementById('mainMenu');
                const content = document.getElementById('mainContent');

                menu.classList.add('collapsed');
                content.classList.add('expanded');
            }
        });
</script>
{% endblock %}
