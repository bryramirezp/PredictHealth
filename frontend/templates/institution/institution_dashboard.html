<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Institucional - PredictHealth</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/institution_dashboard.css') }}">
</head>
<body>
    <!-- Sidebar Navigation -->
    <nav class="main-menu" id="mainMenu">
        <div class="logo-container">
            <div class="logo-icon">
                <i class="fas fa-hospital"></i>
            </div>
            <div class="logo-text">PredictHealth</div>
            <div class="institution-badge">
                <i class="fas fa-building me-1"></i>
                <span id="institutionType">Institución</span>
            </div>
        </div>

        <ul class="nav-menu">
            <li class="nav-item active" data-page="dashboard">
                <b></b>
                <b></b>
                <a href="#" onclick="loadPage('dashboard')">
                    <i class="fa fa-house nav-icon"></i>
                    <span class="nav-text">Dashboard</span>
                </a>
            </li>

            <li class="nav-item" data-page="doctors">
                <b></b>
                <b></b>
                <a href="#" onclick="loadPage('doctors')">
                    <i class="fa fa-user-md nav-icon"></i>
                    <span class="nav-text">Doctores</span>
                </a>
            </li>

            <li class="nav-item" data-page="patients">
                <b></b>
                <b></b>
                <a href="#" onclick="loadPage('patients')">
                    <i class="fa fa-users nav-icon"></i>
                    <span class="nav-text">Pacientes</span>
                </a>
            </li>

            <li class="nav-item" data-page="analytics">
                <b></b>
                <b></b>
                <a href="#" onclick="loadPage('analytics')">
                    <i class="fa fa-chart-bar nav-icon"></i>
                    <span class="nav-text">Analíticas</span>
                </a>
            </li>

            <li class="nav-item" data-page="settings">
                <b></b>
                <b></b>
                <a href="#" onclick="loadPage('settings')">
                    <i class="fa fa-cog nav-icon"></i>
                    <span class="nav-text">Configuración</span>
                </a>
            </li>
        </ul>

        <div class="user-profile">
            <div class="user-info">
                <div class="user-avatar">
                    <i class="fas fa-user"></i>
                </div>
                <div class="user-details">
                    <div class="user-name" id="userName">Institución</div>
                    <div class="user-role">Administrador</div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <section class="content" id="mainContent">
        <div class="content-header">
            <div class="page-info">
                <h1 id="pageTitle">Dashboard</h1>
                <p id="pageSubtitle">Bienvenido a tu panel institucional</p>
            </div>
            <div class="header-actions">
                <button class="menu-toggle" onclick="toggleSidebar()">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
        </div>

        <!-- Top Bar -->
        <div class="top-bar">
            <div class="patient-info">
                <span class="patient-name" id="institutionGreeting">Hola, Institución</span>
                <span class="patient-type">Portal Institucional</span>
            </div>
            <button class="logout-btn" onclick="handleLogout()">
                <i class="fas fa-sign-out-alt"></i>
                Cerrar Sesión
            </button>
        </div>

        <div class="dashboard-content" id="dashboardContent">
            <!-- Dashboard content will be loaded here -->
        </div>
    </section>

    <script>
        // Global variables
        let currentPage = 'dashboard';
        let institutionData = {};

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            loadInstitutionData();
            loadPage('dashboard');
        });

        // Toggle sidebar
        function toggleSidebar() {
            const menu = document.getElementById('mainMenu');
            const content = document.getElementById('mainContent');

            menu.classList.toggle('collapsed');
            content.classList.toggle('expanded');
        }

        // Load institution data
        async function loadInstitutionData() {
            try {
                const response = await fetch('/api/web/institution/dashboard', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include'
                });

                if (response.ok) {
                    const data = await response.json();
                    institutionData = data.data || {};

                    // Update UI with institution data
                    updateInstitutionInfo(institutionData);
                } else if (response.status === 401) {
                    window.location.href = '/institution_login.html';
                }
            } catch (error) {
                console.error('Error loading institution data:', error);
            }
        }

        // Update institution information in UI
        function updateInstitutionInfo(data) {
            if (data.institution) {
                document.getElementById('userName').textContent = data.institution.nombre || 'Institución';
                document.getElementById('institutionType').textContent = data.institution.tipo_institucion || 'Institución';

                // Update greeting in top bar
                const greetingElement = document.getElementById('institutionGreeting');
                if (greetingElement) {
                    greetingElement.textContent = `Hola, ${data.institution.nombre || 'Institución'}`;
                }
            }
        }

        // Load page content
        function loadPage(page) {
            currentPage = page;

            // Update navigation active state
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`[data-page="${page}"]`).classList.add('active');

            // Update page title and subtitle
            updatePageInfo(page);

            // Load page content
            switch(page) {
                case 'dashboard':
                    loadDashboardContent();
                    break;
                case 'doctors':
                    loadDoctorsContent();
                    break;
                case 'patients':
                    loadPatientsContent();
                    break;
                case 'analytics':
                    loadAnalyticsContent();
                    break;
                case 'settings':
                    loadSettingsContent();
                    break;
            }
        }

        // Update page information
        function updatePageInfo(page) {
            const pageInfo = {
                dashboard: { title: 'Dashboard', subtitle: 'Vista general de tu institución' },
                doctors: { title: 'Gestión de Doctores', subtitle: 'Administra el personal médico' },
                patients: { title: 'Pacientes', subtitle: 'Revisa los pacientes atendidos' },
                analytics: { title: 'Analíticas', subtitle: 'Estadísticas y tendencias de salud' },
                settings: { title: 'Configuración', subtitle: 'Administra tu institución' }
            };

            const info = pageInfo[page] || pageInfo.dashboard;
            document.getElementById('pageTitle').textContent = info.title;
            document.getElementById('pageSubtitle').textContent = info.subtitle;
        }

        // Load dashboard content
        function loadDashboardContent() {
            const content = document.getElementById('dashboardContent');

            content.innerHTML = `
                <!-- Statistics -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon doctors">
                                <i class="fas fa-user-md"></i>
                            </div>
                        </div>
                        <div class="stat-number" id="doctors-count">0</div>
                        <div class="stat-label">Doctores Registrados</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon patients">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-number" id="patients-count">0</div>
                        <div class="stat-label">Pacientes Atendidos</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon predictions">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="stat-number" id="predictions-count">0</div>
                        <div class="stat-label">Predicciones Generadas</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon recommendations">
                            <i class="fas fa-clipboard-list"></i>
                        </div>
                        <div class="stat-number" id="recommendations-count">0</div>
                        <div class="stat-label">Recomendaciones Activas</div>
                    </div>
                </div>

                <!-- Actions -->
                <div class="actions-grid">
                    <div class="action-card" onclick="loadPage('doctors')">
                        <div class="action-icon manage-doctors">
                            <i class="fas fa-user-md"></i>
                        </div>
                        <h3 class="action-title">Gestionar Doctores</h3>
                        <p class="action-description">
                            Administra los doctores de tu institución, revisa sus perfiles y especialidades.
                        </p>
                    </div>
                    <div class="action-card" onclick="loadPage('patients')">
                        <div class="action-icon view-patients">
                            <i class="fas fa-users"></i>
                        </div>
                        <h3 class="action-title">Ver Pacientes</h3>
                        <p class="action-description">
                            Revisa los pacientes atendidos por los doctores de tu institución.
                        </p>
                    </div>
                    <div class="action-card" onclick="loadPage('analytics')">
                        <div class="action-icon analytics">
                            <i class="fas fa-chart-bar"></i>
                        </div>
                        <h3 class="action-title">Analíticas</h3>
                        <p class="action-description">
                            Visualiza estadísticas y tendencias de salud de tus pacientes.
                        </p>
                    </div>
                    <div class="action-card" onclick="loadPage('settings')">
                        <div class="action-icon settings">
                            <i class="fas fa-cog"></i>
                        </div>
                        <h3 class="action-title">Configuración</h3>
                        <p class="action-description">
                            Administra la configuración de tu institución y preferencias.
                        </p>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="recent-activity">
                    <h2 class="section-title">
                        <i class="fas fa-clock"></i>
                        Actividad Reciente
                    </h2>
                    <div id="recent-activity-list">
                        <div class="activity-item">
                            <div class="activity-icon doctor-registered">
                                <i class="fas fa-user-plus"></i>
                            </div>
                            <div class="activity-content">
                                <div class="activity-title">Nuevo doctor registrado</div>
                                <div class="activity-time">Hace 2 horas</div>
                            </div>
                        </div>
                        <div class="activity-item">
                            <div class="activity-icon patient-added">
                                <i class="fas fa-user-plus"></i>
                            </div>
                            <div class="activity-content">
                                <div class="activity-title">5 nuevos pacientes agregados</div>
                                <div class="activity-time">Hace 4 horas</div>
                            </div>
                        </div>
                        <div class="activity-item">
                            <div class="activity-icon prediction-generated">
                                <i class="fas fa-chart-line"></i>
                            </div>
                            <div class="activity-content">
                                <div class="activity-title">12 predicciones de riesgo generadas</div>
                                <div class="activity-time">Hace 6 horas</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Load dashboard statistics
            loadDashboardStats();
        }

        // Load dashboard statistics
        async function loadDashboardStats() {
            try {
                const response = await fetch('/api/web/institution/dashboard', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include'
                });

                if (response.ok) {
                    const data = await response.json();
                    const stats = data.data.statistics || {};

                    animateNumber('doctors-count', stats.total_doctors || 0);
                    animateNumber('patients-count', stats.total_patients || 0);
                    animateNumber('predictions-count', stats.active_appointments || 0);
                    animateNumber('recommendations-count', stats.pending_reviews || 0);
                }
            } catch (error) {
                console.error('Error loading dashboard stats:', error);
            }
        }

        // Load doctors content
        function loadDoctorsContent() {
            const content = document.getElementById('dashboardContent');

            content.innerHTML = `
                <div class="page-header-actions" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                    <div></div>
                    <button class="btn btn-primary" onclick="showAddDoctorModal()">
                        <i class="fas fa-plus me-1"></i>
                        Agregar Doctor
                    </button>
                </div>

                <div class="doctors-grid" id="doctorsList">
                    <!-- Doctors will be loaded here -->
                </div>
            `;

            loadDoctors();
        }

        // Load patients content
        function loadPatientsContent() {
            const content = document.getElementById('dashboardContent');

            content.innerHTML = `
                <div class="stats-grid" style="margin-bottom: 2rem;">
                    <div class="stat-card">
                        <div class="stat-number" id="total-patients">0</div>
                        <div class="stat-label">Total Pacientes</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="active-patients">0</div>
                        <div class="stat-label">Pacientes Activos</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="high-risk">0</div>
                        <div class="stat-label">Alto Riesgo</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="new-patients">0</div>
                        <div class="stat-label">Nuevos este Mes</div>
                    </div>
                </div>

                <div class="patients-table">
                    <h3 class="mb-3">
                        <i class="fas fa-list me-2"></i>
                        Lista de Pacientes
                    </h3>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Paciente</th>
                                    <th>Doctor Asignado</th>
                                    <th>Última Visita</th>
                                    <th>Riesgo</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="patientsTableBody">
                                <!-- Patients will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

            loadPatients();
        }

        // Load analytics content
        function loadAnalyticsContent() {
            const content = document.getElementById('dashboardContent');

            content.innerHTML = `
                <div class="alert alert-info" style="margin-bottom: 2rem;">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Privacidad de Datos:</strong>
                    Toda la información mostrada es anónima y agregada para proteger la privacidad del paciente,
                    en cumplimiento con las normativas de protección de datos.
                </div>

                <div class="charts-grid">
                    <div class="chart-card">
                        <h3 class="chart-title">
                            <i class="fas fa-chart-pie"></i>
                            Distribución de Riesgos
                        </h3>
                        <div class="chart-container">
                            <canvas id="riskDistributionChart"></canvas>
                        </div>
                    </div>

                    <div class="chart-card">
                        <h3 class="chart-title">
                            <i class="fas fa-chart-line"></i>
                            Predicciones por Mes
                        </h3>
                        <div class="chart-container">
                            <canvas id="predictionsChart"></canvas>
                        </div>
                    </div>

                    <div class="chart-card">
                        <h3 class="chart-title">
                            <i class="fas fa-user-md"></i>
                            Pacientes por Doctor
                        </h3>
                        <div class="chart-container">
                            <canvas id="patientsPerDoctorChart"></canvas>
                        </div>
                    </div>

                    <div class="chart-card">
                        <h3 class="chart-title">
                            <i class="fas fa-heartbeat"></i>
                            Condiciones Más Comunes
                        </h3>
                        <div class="chart-container">
                            <canvas id="conditionsChart"></canvas>
                        </div>
                    </div>
                </div>
            `;

            // Load Chart.js and initialize charts
            loadAnalyticsCharts();
        }

        // Load settings content
        function loadSettingsContent() {
            const content = document.getElementById('dashboardContent');

            content.innerHTML = `
                <div class="settings-content">
                    <h3>Configuración de la Institución</h3>
                    <p>Funcionalidad de configuración próximamente disponible.</p>
                </div>
            `;
        }

        // Load doctors data
        async function loadDoctors() {
            try {
                const response = await fetch('/api/web/institution/doctors', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include'
                });

                const data = await response.json();

                if (response.ok && data.status === 'success') {
                    displayDoctors(data.doctors || []);
                } else {
                    displayDoctors([]);
                }
            } catch (error) {
                console.error('Error loading doctors:', error);
                displayDoctors([]);
            }
        }

        // Display doctors
        function displayDoctors(doctors) {
            const doctorsList = document.getElementById('doctorsList');

            if (doctors.length === 0) {
                doctorsList.innerHTML = `
                    <div class="col-12">
                        <div class="text-center py-5">
                            <i class="fas fa-user-md fa-3x text-muted mb-3"></i>
                            <h4 class="text-muted">No hay doctores registrados</h4>
                            <p class="text-muted">Comienza agregando el primer doctor a tu institución</p>
                        </div>
                    </div>
                `;
                return;
            }

            doctorsList.innerHTML = doctors.map(doctor => `
                <div class="doctor-card">
                    <div class="doctor-header">
                        <div class="doctor-avatar">
                            <i class="fas fa-user-md"></i>
                        </div>
                        <div class="doctor-info">
                            <h3>Dr. ${doctor.nombre || doctor.first_name} ${doctor.apellido || doctor.last_name}</h3>
                            <p>${doctor.email || doctor.contact_email}</p>
                        </div>
                    </div>
                    <div class="doctor-specialty">${doctor.especialidad || doctor.specialty || 'Sin especialidad'}</div>
                    <div class="doctor-actions">
                        <button class="btn btn-sm btn-outline-primary" onclick="viewDoctor('${doctor.id_doctor || doctor.id}')">
                            <i class="fas fa-eye me-1"></i>
                            Ver Perfil
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteDoctor('${doctor.id_doctor || doctor.id}', '${doctor.nombre || doctor.first_name}')">
                            <i class="fas fa-trash me-1"></i>
                            Eliminar
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Load patients data
        async function loadPatients() {
            try {
                const response = await fetch('/api/web/institution/patients', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include'
                });

                if (response.ok) {
                    const data = await response.json();
                    displayPatients(data.patients || []);
                    updatePatientStats(data.stats || {});
                } else {
                    displayPatients([]);
                }
            } catch (error) {
                console.error('Error loading patients:', error);
                displayPatients([]);
            }
        }

        // Display patients
        function displayPatients(patients) {
            const tableBody = document.getElementById('patientsTableBody');

            if (patients.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-5">
                            <i class="fas fa-users fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">No hay pacientes registrados</h5>
                            <p class="text-muted">Los pacientes aparecerán aquí cuando los doctores los registren</p>
                        </td>
                    </tr>
                `;
                return;
            }

            tableBody.innerHTML = patients.map(patient => {
                const initials = `${patient.nombre.charAt(0)}${patient.apellido.charAt(0)}`;
                const riskLevel = getRiskLevel(patient.risk_score);
                const riskClass = `risk-${riskLevel.toLowerCase()}`;

                return `
                    <tr>
                        <td>
                            <div class="d-flex align-items-center gap-2">
                                <div class="patient-avatar">${initials}</div>
                                <div>
                                    <div class="fw-semibold">${patient.nombre} ${patient.apellido}</div>
                                    <small class="text-muted">${patient.email}</small>
                                </div>
                            </div>
                        </td>
                        <td>${patient.doctor_name || 'Sin asignar'}</td>
                        <td>${formatDate(patient.ultima_visita) || 'N/A'}</td>
                        <td><span class="risk-badge ${riskClass}">${riskLevel}</span></td>
                        <td><span class="badge bg-primary">${getStatusText(patient.estado_validacion)}</span></td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="viewPatient('${patient.id_usuario}')">
                                <i class="fas fa-eye"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Update patient statistics
        function updatePatientStats(stats) {
            document.getElementById('total-patients').textContent = stats.total_patients || 0;
            document.getElementById('active-patients').textContent = stats.active_patients || 0;
            document.getElementById('high-risk').textContent = stats.high_risk || 0;
            document.getElementById('new-patients').textContent = stats.new_this_month || 0;
        }

        // Load analytics charts
        async function loadAnalyticsCharts() {
            // Load Chart.js if not loaded
            if (typeof Chart === 'undefined') {
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/chart.js';
                script.onload = initializeCharts;
                document.head.appendChild(script);
            } else {
                initializeCharts();
            }
        }

        // Initialize charts
        function initializeCharts() {
            // Risk Distribution Chart
            const riskCtx = document.getElementById('riskDistributionChart');
            if (riskCtx) {
                new Chart(riskCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Bajo Riesgo', 'Medio Riesgo', 'Alto Riesgo'],
                        datasets: [{
                            data: [89, 55, 12],
                            backgroundColor: ['#10b981', '#f59e0b', '#ef4444'],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'bottom' }
                        }
                    }
                });
            }

            // Other charts would be initialized similarly
            // For brevity, only showing the risk distribution chart initialization
        }

        // Utility functions
        function animateNumber(elementId, targetNumber) {
            const element = document.getElementById(elementId);
            const duration = 2000;
            const startTime = performance.now();
            const startNumber = 0;

            function updateNumber(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const easeOutQuart = 1 - Math.pow(1 - progress, 4);
                const currentNumber = Math.floor(startNumber + (targetNumber - startNumber) * easeOutQuart);

                element.textContent = currentNumber;

                if (progress < 1) {
                    requestAnimationFrame(updateNumber);
                }
            }

            requestAnimationFrame(updateNumber);
        }

        function getRiskLevel(score) {
            if (score >= 70) return 'Alto';
            if (score >= 40) return 'Medio';
            return 'Bajo';
        }

        function getStatusText(status) {
            switch(status) {
                case 'full_access': return 'Activo';
                case 'institution_validated': return 'Validado';
                case 'doctor_validated': return 'En Revisión';
                case 'pending': return 'Pendiente';
                default: return 'Desconocido';
            }
        }

        function formatDate(dateString) {
            if (!dateString) return null;
            const date = new Date(dateString);
            return date.toLocaleDateString('es-ES');
        }

        // Placeholder functions for actions
        function showAddDoctorModal() {
            alert('Funcionalidad de agregar doctor próximamente disponible');
        }

        function viewDoctor(doctorId) {
            alert('Funcionalidad de ver perfil próximamente disponible');
        }

        function deleteDoctor(doctorId, doctorName) {
            if (confirm(`¿Estás seguro de que deseas eliminar al Dr. ${doctorName}?`)) {
                alert('Funcionalidad de eliminar doctor próximamente disponible');
            }
        }

        function viewPatient(patientId) {
            alert('Funcionalidad de ver paciente próximamente disponible');
        }

        // Handle logout
        async function handleLogout() {
            if (confirm('¿Estás seguro de que quieres cerrar sesión?')) {
                try {
                    const response = await fetch('/auth/logout', {
                        method: 'POST',
                        credentials: 'include'
                    });

                    if (response.ok) {
                        window.location.href = '/';
                    } else {
                        console.error('Error en logout:', response.status);
                        alert('Error al cerrar sesión. Inténtalo de nuevo.');
                    }
                } catch (error) {
                    console.error('Error de conexión en logout:', error);
                    alert('Error de conexión. Inténtalo de nuevo.');
                }
            }
        }

        // Handle window resize for responsive sidebar
        window.addEventListener('resize', function() {
            if (window.innerWidth <= 768) {
                const menu = document.getElementById('mainMenu');
                const content = document.getElementById('mainContent');

                menu.classList.add('collapsed');
                content.classList.add('expanded');
            }
        });
    </script>
</body>
</html>
