<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Autenticaci贸n JWT | PredictHealth</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/docs.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <a href="/" class="logo">
                <i class="fas fa-heartbeat"></i>
                PredictHealth Docs
            </a>
            <a href="/docs" class="back-btn">
                <i class="fas fa-arrow-left"></i> Volver
            </a>
        </div>
    </header>

    <!-- Main Container -->
    <div class="docs-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-section">
                <div class="sidebar-title">Introducci贸n</div>
                <ul class="sidebar-links">
                    <li><a href="/docs" class="sidebar-link">Visi贸n General</a></li>
                    <li><a href="/docs/arquitectura" class="sidebar-link">Arquitectura del Sistema</a></li>
                </ul>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-title">Backend</div>
                <ul class="sidebar-links">
                    <li><a href="/docs/backend/flask" class="sidebar-link">Flask API</a></li>
                    <li><a href="/docs/backend/microservicios" class="sidebar-link">Microservicios</a></li>
                    <li><a href="/docs/backend/autenticacion" class="sidebar-link active">Autenticaci贸n JWT</a></li>
                </ul>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-title">Frontend</div>
                <ul class="sidebar-links">
                    <li><a href="/docs/frontend/estructura" class="sidebar-link">Estructura</a></li>
                    <li><a href="/docs/frontend/componentes" class="sidebar-link">Componentes</a></li>
                    <li><a href="/docs/frontend/estilos" class="sidebar-link">Estilos y Dise帽o</a></li>
                </ul>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-title">Base de Datos</div>
                <ul class="sidebar-links">
                    <li><a href="/docs/database/postgresql" class="sidebar-link">PostgreSQL</a></li>
                    <li><a href="/docs/database/redis" class="sidebar-link">Redis Cache</a></li>
                    <li><a href="/docs/database/firebase" class="sidebar-link">Firebase</a></li>
                </ul>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-title">Machine Learning</div>
                <ul class="sidebar-links">
                    <li><a href="/docs/ml/modelos" class="sidebar-link">Modelos Predictivos</a></li>
                    <li><a href="/docs/ml/entrenamiento" class="sidebar-link">Entrenamiento</a></li>
                    <li><a href="/docs/ml/deployment" class="sidebar-link">Despliegue</a></li>
                </ul>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-title">Dispositivos</div>
                <ul class="sidebar-links">
                    <li><a href="/docs/devices/mobile" class="sidebar-link">App M贸vil</a></li>
                    <li><a href="/docs/devices/leap-motion" class="sidebar-link">Leap Motion</a></li>
                </ul>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-title">Deployment</div>
                <ul class="sidebar-links">
                    <li><a href="/docs/deploy/docker" class="sidebar-link">Docker</a></li>
                    <li><a href="/docs/deploy/produccion" class="sidebar-link">Producci贸n</a></li>
                </ul>
            </div>
        </aside>

        <!-- Content -->
        <main class="content">
            <h1 class="page-title">
                <span class="emoji"></span>
                Autenticaci贸n JWT
            </h1>

            <p class="intro-text">
                Sistema de autenticaci贸n basado en tokens JWT (JSON Web Tokens) con validaci贸n contra Redis. Proporciona autenticaci贸n stateless con gesti贸n de sesiones mediante cookies HTTP-only y almacenamiento de tokens en cach茅.
            </p>

            <h2>Flujo de Autenticaci贸n</h2>
            <p>
                El flujo completo de autenticaci贸n sigue estos pasos:
            </p>

            <ol>
                <li>Usuario inicia sesi贸n v铆a API Gateway (<code>/api/web/auth/login</code>)</li>
                <li>API Gateway delega autenticaci贸n a <code>auth-jwt-service</code></li>
                <li>Token JWT se genera y almacena en Redis con formato <code>access_token:{jwt_token}</code></li>
                <li>Cookie HTTP-only (<code>predicthealth_jwt</code>) se establece en el cliente</li>
                <li>Requests subsecuentes incluyen cookie autom谩ticamente</li>
                <li>Middleware JWT valida token contra Redis en cada request protegido</li>
            </ol>

            <h2>Almacenamiento de Tokens</h2>
            <p>
                Los tokens JWT se almacenan en Redis para validaci贸n r谩pida y gesti贸n de sesiones:
            </p>

            <div class="tech-section">
                <h3>Formato en Redis</h3>
                <ul>
                    <li><strong>Key:</strong> <code>access_token:{jwt_token}</code></li>
                    <li><strong>Value:</strong> JWT token (string)</li>
                    <li><strong>TTL:</strong> 15 minutos (900 segundos) por defecto</li>
                </ul>

                <h3>Configuraci贸n de Cookie</h3>
                <ul>
                    <li><strong>Nombre:</strong> <code>predicthealth_jwt</code></li>
                    <li><strong>HttpOnly:</strong> S铆 (protecci贸n XSS)</li>
                    <li><strong>Secure:</strong> False (True en producci贸n con HTTPS)</li>
                    <li><strong>SameSite:</strong> Lax</li>
                    <li><strong>Path:</strong> <code>/</code></li>
                    <li><strong>Max-Age:</strong> 900 segundos (15 minutos)</li>
                </ul>
            </div>

            <h2>JWT Middleware</h2>
            <p>
                El middleware JWT proporciona decoradores para proteger rutas y validar sesiones:
            </p>

            <div class="tech-section">
                <h3>Decoradores Disponibles</h3>
                <pre><code>from app.middleware.jwt_middleware import require_session, require_auth, optional_session

# Requiere sesi贸n v谩lida (desde cookie)
@require_session
def protected_route():
    user = g.current_user
    return jsonify(user)

# Requiere tipo de usuario espec铆fico
@require_auth(required_user_type='doctor')
def doctor_only_route():
    return jsonify({'message': 'Doctor access'})

# Sesi贸n opcional
@optional_session
def public_route():
    if is_authenticated():
        return jsonify(g.current_user)
    return jsonify({'message': 'Public'})</code></pre>

                <h3>Funcionalidad</h3>
                <ul>
                    <li>Validaci贸n de token contra Redis en cada request</li>
                    <li>Extracci贸n de informaci贸n de usuario desde token JWT</li>
                    <li>Inyecci贸n de <code>g.current_user</code> y <code>g.token</code> en contexto</li>
                    <li>Renovaci贸n autom谩tica de token en uso</li>
                    <li>Logout seguro con eliminaci贸n de token en Redis</li>
                </ul>
            </div>

            <h2>Endpoints de Autenticaci贸n</h2>

            <div class="tech-section">
                <h3>API Gateway (<code>/api/v1/auth/</code>)</h3>
                <ul>
                    <li><code>POST /api/v1/auth/login</code> - Login gen茅rico con creaci贸n de sesi贸n</li>
                    <li><code>POST /api/v1/auth/logout</code> - Logout y revocaci贸n de token</li>
                    <li><code>GET /api/v1/auth/session/validate</code> - Validar sesi贸n activa</li>
                    <li><code>GET /api/v1/auth/jwt/health</code> - Health check del servicio JWT</li>
                </ul>

                <h3>Web API (<code>/api/web/auth/</code>)</h3>
                <ul>
                    <li><code>POST /api/web/auth/login</code> - Login gen茅rico (auto-detecta tipo de usuario)</li>
                    <li><code>POST /api/web/auth/patient/login</code> - Login espec铆fico de paciente</li>
                    <li><code>POST /api/web/auth/doctor/login</code> - Login espec铆fico de doctor</li>
                    <li><code>POST /api/web/auth/institution/login</code> - Login espec铆fico de instituci贸n</li>
                    <li><code>POST /api/web/auth/logout</code> - Logout</li>
                    <li><code>GET /api/web/auth/session/validate</code> - Validar sesi贸n</li>
                    <li><code>GET /api/web/auth/token</code> - Obtener token actual (protegido)</li>
                </ul>
            </div>

            <h2>Seguridad de Contrase帽as</h2>
            <p>
                Las contrase帽as se hashean usando bcrypt antes de almacenarse:
            </p>

            <div class="tech-section">
                <h3>Hashing con bcrypt</h3>
                <ul>
                    <li>Algoritmo: bcrypt con salt autom谩tico</li>
                    <li>Rounds: Configurables (default: 12)</li>
                    <li>Validaci贸n: Comparaci贸n segura contra hash almacenado</li>
                    <li>Implementaci贸n: Manejada por auth-jwt-service</li>
                </ul>

                <h3>Protecci贸n de Cuentas</h3>
                <ul>
                    <li>Seguimiento de intentos fallidos de login</li>
                    <li>Pol铆ticas de bloqueo configurables</li>
                    <li>Registro de eventos de autenticaci贸n en tabla <code>users</code></li>
                </ul>
            </div>

            <h2>Validaci贸n de Sesiones</h2>
            <p>
                Cada request protegido valida el token JWT contra Redis:
            </p>

            <div class="tech-section">
                <h3>Proceso de Validaci贸n</h3>
                <ol>
                    <li>Extracci贸n de token desde cookie <code>predicthealth_jwt</code> o header Authorization</li>
                    <li>B煤squeda en Redis con key <code>access_token:{jwt_token}</code></li>
                    <li>Decodificaci贸n y verificaci贸n de firma del token JWT</li>
                    <li>Validaci贸n de expiraci贸n y claims del token</li>
                    <li>Inyecci贸n de informaci贸n de usuario en contexto Flask (<code>g.current_user</code>)</li>
                </ol>

                <h3>Informaci贸n del Token</h3>
                <p>
                    Los tokens JWT contienen:
                </p>
                <ul>
                    <li><code>user_id</code> - ID del usuario</li>
                    <li><code>user_type</code> - Tipo de usuario (patient, doctor, institution)</li>
                    <li><code>reference_id</code> - ID de la entidad de dominio asociada</li>
                    <li><code>exp</code> - Timestamp de expiraci贸n</li>
                    <li><code>iat</code> - Timestamp de emisi贸n</li>
                </ul>
            </div>

            <h2>Autenticaci贸n Inter-Servicios</h2>
            <p>
                Los microservicios validan tokens JWT para comunicaci贸n entre servicios:
            </p>

            <div class="tech-section">
                <h3>Flujo</h3>
                <ol>
                    <li>Microservicio recibe request con token JWT en header Authorization</li>
                    <li>Token se valida v铆a auth-jwt-service o decodificaci贸n local</li>
                    <li><code>reference_id</code> se extrae del token para acceso a entidades</li>
                    <li>Request se procesa con contexto de usuario autenticado</li>
                </ol>

                <h3>Cliente Auth Compartido</h3>
                <p>
                    M贸dulo <code>shared/auth_client.py</code> proporciona creaci贸n estandarizada de usuarios:
                </p>
                <pre><code>from microservices.shared.auth_client import create_user

create_user(email, password, user_type, reference_id)</code></pre>
            </div>

            <h2>Configuraci贸n</h2>
            <div>
                <span class="badge">JWT_SECRET_KEY</span>
                <span class="badge">JWT_ALGORITHM (HS256)</span>
                <span class="badge">REDIS_URL</span>
                <span class="badge">PyJWT 2.8.0</span>
                <span class="badge">bcrypt 4.2.0</span>
            </div>

            <p class="footer-note">
                <i class="fas fa-info-circle"></i>
                El sistema de autenticaci贸n JWT proporciona seguridad stateless con validaci贸n r谩pida mediante Redis, permitiendo escalabilidad horizontal sin dependencia de sesiones en servidor.
            </p>
        </main>
    </div>
</body>
</html>