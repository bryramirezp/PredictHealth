<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Flask API | PredictHealth</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/docs.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <a href="/" class="logo">
                <i class="fas fa-heartbeat"></i>
                PredictHealth Docs
            </a>
            <a href="/docs" class="back-btn">
                <i class="fas fa-arrow-left"></i> Volver
            </a>
        </div>
    </header>

    <!-- Main Container -->
    <div class="docs-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-section">
                <div class="sidebar-title">Introducci贸n</div>
                <ul class="sidebar-links">
                    <li><a href="/docs" class="sidebar-link">Visi贸n General</a></li>
                    <li><a href="/docs/arquitectura" class="sidebar-link">Arquitectura del Sistema</a></li>
                </ul>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-title">Backend</div>
                <ul class="sidebar-links">
                    <li><a href="/docs/backend/flask" class="sidebar-link active">Flask API</a></li>
                    <li><a href="/docs/backend/microservicios" class="sidebar-link">Microservicios</a></li>
                    <li><a href="/docs/backend/autenticacion" class="sidebar-link">Autenticaci贸n JWT</a></li>
                </ul>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-title">Frontend</div>
                <ul class="sidebar-links">
                    <li><a href="/docs/frontend/estructura" class="sidebar-link">Estructura</a></li>
                    <li><a href="/docs/frontend/componentes" class="sidebar-link">Componentes</a></li>
                    <li><a href="/docs/frontend/estilos" class="sidebar-link">Estilos y Dise帽o</a></li>
                </ul>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-title">Base de Datos</div>
                <ul class="sidebar-links">
                    <li><a href="/docs/database/postgresql" class="sidebar-link">PostgreSQL</a></li>
                    <li><a href="/docs/database/redis" class="sidebar-link">Redis Cache</a></li>
                    <li><a href="/docs/database/firebase" class="sidebar-link">Firebase</a></li>
                </ul>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-title">Machine Learning</div>
                <ul class="sidebar-links">
                    <li><a href="/docs/ml/modelos" class="sidebar-link">Modelos Predictivos</a></li>
                    <li><a href="/docs/ml/entrenamiento" class="sidebar-link">Entrenamiento</a></li>
                    <li><a href="/docs/ml/deployment" class="sidebar-link">Despliegue</a></li>
                </ul>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-title">Dispositivos</div>
                <ul class="sidebar-links">
                    <li><a href="/docs/devices/mobile" class="sidebar-link">App M贸vil</a></li>
                    <li><a href="/docs/devices/leap-motion" class="sidebar-link">Leap Motion</a></li>
                </ul>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-title">Deployment</div>
                <ul class="sidebar-links">
                    <li><a href="/docs/deploy/docker" class="sidebar-link">Docker</a></li>
                    <li><a href="/docs/deploy/produccion" class="sidebar-link">Producci贸n</a></li>
                </ul>
            </div>
        </aside>

        <!-- Content -->
        <main class="content">
            <h1 class="page-title">
                <span class="emoji"></span>
                Flask API Gateway
            </h1>

            <p class="intro-text">
                Flask-based API Gateway y web server que act煤a como punto de entrada 煤nico para todas las peticiones del frontend. Maneja renderizado de p谩ginas HTML, enrutamiento a microservicios y autenticaci贸n JWT.
            </p>

            <h2>Componentes Principales</h2>

            <div class="tech-grid">
                <div class="tech-card">
                    <h4><i class="fas fa-route" style="color: #4dd9d6;"></i> API Gateway</h4>
                    <p>Enrutamiento HTTP a microservicios con inyecci贸n autom谩tica de tokens JWT en headers.</p>
                </div>

                <div class="tech-card">
                    <h4><i class="fas fa-globe" style="color: #667eea;"></i> Web Server</h4>
                    <p>Servidor de p谩ginas HTML, templates Jinja2 y archivos est谩ticos (CSS, JS, im谩genes).</p>
                </div>

                <div class="tech-card">
                    <h4><i class="fas fa-shield-alt" style="color: #f59e0b;"></i> JWT Middleware</h4>
                    <p>Validaci贸n de autenticaci贸n JWT con Redis para gesti贸n de sesiones y tokens.</p>
                </div>

                <div class="tech-card">
                    <h4><i class="fas fa-exchange-alt" style="color: #8b5cf6;"></i> Proxy Service</h4>
                    <p>Proxy inteligente con l贸gica de reintentos (backoff exponencial, 3 intentos, 1s base delay).</p>
                </div>

                <div class="tech-card">
                    <h4><i class="fas fa-user-shield" style="color: #10b981;"></i> Frontend Controller</h4>
                    <p>Renderizado server-side de p谩ginas con control de acceso basado en roles.</p>
                </div>
            </div>

            <h2>Stack Tecnol贸gico</h2>
            <div>
                <span class="badge">Flask 2.3.3</span>
                <span class="badge">JWT</span>
                <span class="badge">Redis</span>
                <span class="badge">Flask-CORS</span>
                <span class="badge">Jinja2</span>
                <span class="badge">PyJWT 2.8.0</span>
                <span class="badge">requests 2.31.0</span>
            </div>

            <h2>Estructura del Proyecto</h2>
            <p>
                Organizaci贸n modular con separaci贸n de responsabilidades:
            </p>

            <div class="folders-section">
                <div class="folder-item">
                    <div class="folder-name">
                        <i class="fas fa-folder" style="color: #4dd9d6;"></i>
                        <strong>app/core/</strong>
                    </div>
                    <p class="folder-description">Configuraci贸n centralizada (config.py).</p>
                </div>

                <div class="folder-item">
                    <div class="folder-name">
                        <i class="fas fa-folder" style="color: #667eea;"></i>
                        <strong>app/api/v1/</strong>
                    </div>
                    <p class="folder-description">Blueprints de API: gateway.py (proxy), auth.py, web_controller.py, main.py.</p>
                </div>

                <div class="folder-item">
                    <div class="folder-name">
                        <i class="fas fa-folder" style="color: #f59e0b;"></i>
                        <strong>app/middleware/</strong>
                    </div>
                    <p class="folder-description">JWT middleware con validaci贸n Redis (jwt_middleware.py).</p>
                </div>

                <div class="folder-item">
                    <div class="folder-name">
                        <i class="fas fa-folder" style="color: #8b5cf6;"></i>
                        <strong>app/services/</strong>
                    </div>
                    <p class="folder-description">Proxy service, health service, logging service.</p>
                </div>

                <div class="folder-item">
                    <div class="folder-name">
                        <i class="fas fa-folder" style="color: #10b981;"></i>
                        <strong>app/controllers/</strong>
                    </div>
                    <p class="folder-description">Frontend controller para rutas de dashboards.</p>
                </div>
            </div>

            <h2>API Gateway</h2>
            <p>
                Enrutamiento autom谩tico a microservicios basado en patrones de URL:
            </p>

            <div class="tech-section">
                <h3>Configuraci贸n de Microservicios</h3>
                <pre><code>MICROSERVICES = {
    'jwt': 'http://servicio-auth-jwt:8003',
    'doctors': 'http://servicio-doctores:8000',
    'patients': 'http://servicio-pacientes:8004',
    'institutions': 'http://servicio-instituciones:8002',
    'admins': 'http://servicio-admins:8006'
}</code></pre>

                <h3>Caracter铆sticas</h3>
                <ul>
                    <li>Enrutamiento autom谩tico seg煤n URL pattern</li>
                    <li>Inyecci贸n de JWT Bearer token en headers Authorization</li>
                    <li>Reintentos con backoff exponencial (3 intentos, 1s base delay)</li>
                    <li>Timeouts configurables (10s default)</li>
                    <li>Manejo autom谩tico del prefijo <code>/api/v1</code> para servicios de dominio</li>
                </ul>
            </div>

            <h2>Endpoints Principales</h2>

            <div class="tech-section">
                <h3>API Gateway (<code>/api/v1/</code>)</h3>
                <ul>
                    <li><code>GET/POST/PUT/DELETE /api/v1/auth/&lt;path&gt;</code> - Proxy a servicio de autenticaci贸n</li>
                    <li><code>GET/POST/PUT/DELETE /api/v1/patients/&lt;path&gt;</code> - Proxy a servicio de pacientes (protegido)</li>
                    <li><code>GET/POST/PUT/DELETE /api/v1/doctors/&lt;path&gt;</code> - Proxy a servicio de doctores (protegido)</li>
                    <li><code>GET/POST/PUT/DELETE /api/v1/institutions/&lt;path&gt;</code> - Proxy a servicio de instituciones (protegido)</li>
                </ul>

                <h3>Web API (<code>/api/web/</code>)</h3>
                <ul>
                    <li><code>POST /api/web/auth/login</code> - Login gen茅rico (auto-detecta tipo de usuario)</li>
                    <li><code>POST /api/web/auth/logout</code> - Logout y revocaci贸n de token</li>
                    <li><code>GET /api/web/auth/session/validate</code> - Validar sesi贸n activa</li>
                    <li><code>GET /api/web/patient/dashboard</code> - Dashboard de paciente (protegido)</li>
                    <li><code>GET /api/web/doctor/dashboard</code> - Dashboard de doctor (protegido)</li>
                    <li><code>GET /api/web/institution/dashboard</code> - Dashboard de instituci贸n (protegido)</li>
                </ul>

                <h3>P谩ginas Web</h3>
                <ul>
                    <li><code>GET /</code> - Landing page</li>
                    <li><code>GET /patient/dashboard</code> - Dashboard de paciente (protegido, rol patient)</li>
                    <li><code>GET /doctor/dashboard</code> - Dashboard de doctor (protegido, rol doctor)</li>
                    <li><code>GET /institution/dashboard</code> - Dashboard de instituci贸n (protegido, rol institution)</li>
                    <li><code>GET /docs</code> - Documentaci贸n</li>
                </ul>
            </div>

            <h2>JWT Middleware</h2>
            <p>
                Sistema de autenticaci贸n basado en tokens JWT con validaci贸n contra Redis:
            </p>

            <div class="tech-section">
                <h3>Decoradores</h3>
                <pre><code>from app.middleware.jwt_middleware import require_session, require_auth

@require_session
def protected_route():
    user = g.current_user
    return jsonify(user)

@require_auth(required_user_type='doctor')
def doctor_only_route():
    return jsonify({'message': 'Doctor access'})</code></pre>

                <h3>Almacenamiento de Sesiones</h3>
                <ul>
                    <li>Tokens almacenados en Redis con formato: <code>access_token:{jwt_token}</code></li>
                    <li>TTL: 15 minutos (900 segundos) por defecto</li>
                    <li>Cookie HTTP-only: <code>predicthealth_jwt</code></li>
                    <li>Configuraci贸n: HttpOnly, SameSite=Lax, Path=/</li>
                </ul>
            </div>

            <h2>Proxy Service</h2>
            <p>
                Servicio de proxy inteligente con manejo de errores y reintentos:
            </p>

            <div class="tech-section">
                <h3>Caracter铆sticas</h3>
                <ul>
                    <li>Manejo autom谩tico del prefijo <code>/api/v1</code> para servicios de dominio</li>
                    <li>Inyecci贸n de JWT Bearer token en todos los requests (desde <code>g.token</code> o cookie)</li>
                    <li>Backoff exponencial en reintentos (3 intentos, 1s base delay)</li>
                    <li>Timeouts configurables (10s default)</li>
                    <li>Manejo completo de errores con logging</li>
                </ul>

                <h3>Uso</h3>
                <pre><code>from app.services.proxy_service import proxy_service

# Proxy gen茅rico
response = proxy_service.proxy_get('doctors', '/api/v1/doctors/')
response = proxy_service.proxy_post('patients', '/api/v1/patients/', data)

# M茅todos espec铆ficos por servicio
response = proxy_service.call_doctors_service('GET', '/api/v1/doctors/')
response = proxy_service.call_patients_service('POST', '/api/v1/patients/', data)</code></pre>
            </div>

            <h2>Configuraci贸n</h2>
            <p>
                Variables de entorno principales:
            </p>

            <div class="tech-section">
                <h3>JWT y Autenticaci贸n</h3>
                <ul>
                    <li><code>JWT_SECRET_KEY</code> - Clave secreta para firmar tokens</li>
                    <li><code>JWT_ALGORITHM</code> - Algoritmo de firma (HS256)</li>
                    <li><code>REDIS_URL</code> - URL de conexi贸n a Redis</li>
                </ul>

                <h3>Microservicios</h3>
                <ul>
                    <li><code>JWT_SERVICE_URL</code> - URL del servicio de autenticaci贸n</li>
                    <li><code>DOCTOR_SERVICE_URL</code> - URL del servicio de doctores</li>
                    <li><code>PATIENT_SERVICE_URL</code> - URL del servicio de pacientes</li>
                    <li><code>INSTITUTION_SERVICE_URL</code> - URL del servicio de instituciones</li>
                </ul>

                <h3>Flask</h3>
                <ul>
                    <li><code>SECRET_KEY</code> - Clave secreta de Flask</li>
                    <li><code>FLASK_ENV</code> - Entorno (development/production)</li>
                    <li><code>CORS_ORIGINS</code> - Or铆genes permitidos para CORS</li>
                </ul>
            </div>

            <p class="footer-note">
                <i class="fas fa-info-circle"></i>
                El API Gateway proporciona un punto de entrada 煤nico que simplifica la comunicaci贸n del frontend con los microservicios y centraliza la autenticaci贸n.
            </p>
        </main>
    </div>
</body>
</html>