<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Microservicios | PredictHealth</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/docs.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <a href="/" class="logo">
                <i class="fas fa-heartbeat"></i>
                PredictHealth Docs
            </a>
            <a href="/docs" class="back-btn">
                <i class="fas fa-arrow-left"></i> Volver
            </a>
        </div>
    </header>

    <!-- Main Container -->
    <div class="docs-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-section">
                <div class="sidebar-title">Introducci√≥n</div>
                <ul class="sidebar-links">
                    <li><a href="/docs" class="sidebar-link">Visi√≥n General</a></li>
                    <li><a href="/docs/arquitectura" class="sidebar-link">Arquitectura del Sistema</a></li>
                </ul>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-title">Backend</div>
                <ul class="sidebar-links">
                    <li><a href="/docs/backend/flask" class="sidebar-link">Flask API</a></li>
                    <li><a href="/docs/backend/microservicios" class="sidebar-link active">Microservicios</a></li>
                    <li><a href="/docs/backend/autenticacion" class="sidebar-link">Autenticaci√≥n JWT</a></li>
                </ul>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-title">Frontend</div>
                <ul class="sidebar-links">
                    <li><a href="/docs/frontend/estructura" class="sidebar-link">Estructura</a></li>
                    <li><a href="/docs/frontend/componentes" class="sidebar-link">Componentes</a></li>
                    <li><a href="/docs/frontend/estilos" class="sidebar-link">Estilos y Dise√±o</a></li>
                </ul>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-title">Base de Datos</div>
                <ul class="sidebar-links">
                    <li><a href="/docs/database/postgresql" class="sidebar-link">PostgreSQL</a></li>
                    <li><a href="/docs/database/redis" class="sidebar-link">Redis Cache</a></li>
                    <li><a href="/docs/database/firebase" class="sidebar-link">Firebase</a></li>
                </ul>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-title">Machine Learning</div>
                <ul class="sidebar-links">
                    <li><a href="/docs/ml/modelos" class="sidebar-link">Modelos Predictivos</a></li>
                    <li><a href="/docs/ml/entrenamiento" class="sidebar-link">Entrenamiento</a></li>
                    <li><a href="/docs/ml/deployment" class="sidebar-link">Despliegue</a></li>
                </ul>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-title">Dispositivos</div>
                <ul class="sidebar-links">
                    <li><a href="/docs/devices/mobile" class="sidebar-link">App M√≥vil</a></li>
                    <li><a href="/docs/devices/leap-motion" class="sidebar-link">Leap Motion</a></li>
                </ul>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-title">Deployment</div>
                <ul class="sidebar-links">
                    <li><a href="/docs/deploy/docker" class="sidebar-link">Docker</a></li>
                    <li><a href="/docs/deploy/produccion" class="sidebar-link">Producci√≥n</a></li>
                </ul>
            </div>
        </aside>

        <!-- Content -->
        <main class="content">
            <h1 class="page-title">
                <span class="emoji">üîß</span>
                Microservicios
            </h1>

            <p class="intro-text">
                Arquitectura de microservicios escalable y modular para gesti√≥n de datos de salud. Cuatro microservicios especializados que manejan diferentes aspectos de la plataforma, comunic√°ndose mediante APIs REST y compartiendo una base de datos PostgreSQL con Redis para cach√©.
            </p>

            <h2>Stack Tecnol√≥gico</h2>
            <div>
                <span class="badge">FastAPI 0.104.1</span>
                <span class="badge">PostgreSQL</span>
                <span class="badge">Redis 5.0.1</span>
                <span class="badge">Docker</span>
                <span class="badge">Pydantic 2.5.0</span>
                <span class="badge">PyJWT 2.8.0</span>
                <span class="badge">bcrypt 4.2.0</span>
                <span class="badge">psycopg2-binary 2.9.9</span>
            </div>

            <h2>Servicios Individuales</h2>

            <div class="tech-grid">
                <div class="tech-card">
                    <h4><i class="fas fa-key" style="color: #4dd9d6;"></i> Auth-JWT Service</h4>
                    <p>Puerto 8003. Servicio centralizado de autenticaci√≥n y gesti√≥n de tokens JWT. Almacenamiento en Redis.</p>
                </div>

                <div class="tech-card">
                    <h4><i class="fas fa-user-md" style="color: #667eea;"></i> Doctors Service</h4>
                    <p>Puerto 8000. Gesti√≥n de perfiles de doctores, especialidades, licencias m√©dicas y asociaciones con instituciones.</p>
                </div>

                <div class="tech-card">
                    <h4><i class="fas fa-hospital" style="color: #f59e0b;"></i> Institutions Service</h4>
                    <p>Puerto 8002. Gesti√≥n de instituciones m√©dicas, organizaci√≥n geogr√°fica y verificaci√≥n de licencias.</p>
                </div>

                <div class="tech-card">
                    <h4><i class="fas fa-user-injured" style="color: #8b5cf6;"></i> Patients Service</h4>
                    <p>Puerto 8004. Gesti√≥n de datos de pacientes, perfiles de salud, flujos de validaci√≥n y expedientes m√©dicos.</p>
                </div>
            </div>

            <h2>Auth-JWT Service</h2>
            <p>
                Servicio centralizado de autenticaci√≥n y gesti√≥n de tokens JWT.
            </p>

            <div class="tech-section">
                <h3>Caracter√≠sticas</h3>
                <ul>
                    <li>Creaci√≥n, verificaci√≥n y validaci√≥n de tokens JWT</li>
                    <li>Almacenamiento de tokens en Redis</li>
                    <li>Creaci√≥n y gesti√≥n de cuentas de usuario</li>
                    <li>Soporte para autenticaci√≥n inter-servicios</li>
                    <li>Hashing de contrase√±as con bcrypt</li>
                </ul>

                <h3>Endpoints Principales</h3>
                <ul>
                    <li><code>POST /auth/login</code> - Autenticaci√≥n de usuario</li>
                    <li><code>POST /auth/verify-token</code> - Verificar validez de token</li>
                    <li><code>POST /auth/session/validate</code> - Validar sesi√≥n JWT</li>
                    <li><code>POST /auth/logout</code> - Cerrar sesi√≥n</li>
                    <li><code>POST /users/create</code> - Crear nueva cuenta de usuario</li>
                </ul>
            </div>

            <h2>Doctors Service</h2>
            <p>
                Gesti√≥n de datos de proveedores de salud y asociaciones de especialidades.
            </p>

            <div class="tech-section">
                <h3>Endpoints para Doctores Autenticados</h3>
                <ul>
                    <li><code>GET /api/v1/doctors/me/dashboard</code> - KPIs del dashboard</li>
                    <li><code>GET /api/v1/doctors/me/profile</code> - Perfil del doctor</li>
                    <li><code>PUT /api/v1/doctors/me/profile</code> - Actualizar perfil</li>
                    <li><code>GET /api/v1/doctors/me/institution</code> - Instituci√≥n asociada</li>
                    <li><code>GET /api/v1/doctors/me/patients</code> - Lista de pacientes asignados</li>
                    <li><code>GET /api/v1/doctors/me/patients/{id}/medical-record</code> - Expediente m√©dico</li>
                </ul>

                <h3>L√≥gica de Negocio</h3>
                <ul>
                    <li>Restricciones de email y licencia m√©dica √∫nicos</li>
                    <li>Validaci√≥n de estado profesional (active, suspended, retired)</li>
                    <li>Transacci√≥n at√≥mica para creaci√≥n (incluye cuenta de usuario)</li>
                </ul>
            </div>

            <h2>Institutions Service</h2>
            <p>
                Gesti√≥n de instituciones m√©dicas y organizaci√≥n geogr√°fica.
            </p>

            <div class="tech-section">
                <h3>Endpoints Principales</h3>
                <ul>
                    <li><code>GET /api/v1/institutions</code> - Listar instituciones con filtrado</li>
                    <li><code>POST /api/v1/institutions</code> - Crear nueva instituci√≥n</li>
                    <li><code>GET /api/v1/institutions/{id}</code> - Detalles de instituci√≥n</li>
                    <li><code>PUT /api/v1/institutions/{id}</code> - Actualizar instituci√≥n</li>
                    <li><code>DELETE /api/v1/institutions/{id}</code> - Eliminar instituci√≥n (soft delete)</li>
                </ul>

                <h3>L√≥gica de Negocio</h3>
                <ul>
                    <li>Validaci√≥n de tipo de instituci√≥n (cl√≠nica, hospital, aseguradora, etc.)</li>
                    <li>Email de contacto y n√∫mero de licencia √∫nicos</li>
                    <li>Seguimiento de regi√≥n geogr√°fica y estado de verificaci√≥n</li>
                </ul>
            </div>

            <h2>Patients Service</h2>
            <p>
                Gesti√≥n de datos de pacientes y seguimiento de perfiles de salud.
            </p>

            <div class="tech-section">
                <h3>Endpoints Principales</h3>
                <ul>
                    <li><code>GET /api/v1/patients</code> - Listar pacientes con filtrado</li>
                    <li><code>POST /api/v1/patients</code> - Crear nuevo paciente</li>
                    <li><code>GET /api/v1/patients/{id}/dashboard</code> - Dashboard del paciente</li>
                    <li><code>GET /api/v1/patients/{id}/medical-record</code> - Expediente m√©dico completo</li>
                    <li><code>GET /api/v1/patients/{id}/care-team</code> - Equipo m√©dico</li>
                    <li><code>GET /api/v1/patients/{id}/profile</code> - Perfil del paciente</li>
                </ul>

                <h3>L√≥gica de Negocio</h3>
                <ul>
                    <li>Progresi√≥n de validaci√≥n: pending ‚Üí validated_by_doctor ‚Üí validated_by_institution ‚Üí full_access</li>
                    <li>Asociaci√≥n m√©dica requerida (doctor O instituci√≥n)</li>
                    <li>Transacci√≥n at√≥mica para creaci√≥n (incluye cuenta de usuario y perfil de salud)</li>
                    <li>C√°lculo de KPIs: health score, BMI, edad, clasificaci√≥n BMI</li>
                </ul>
            </div>

            <h2>Estructura Com√∫n</h2>
            <p>
                Todos los microservicios siguen una arquitectura consistente:
            </p>

            <div class="folders-section">
                <div class="folder-item">
                    <div class="folder-name">
                        <i class="fas fa-file-code" style="color: #4dd9d6;"></i>
                        <strong>app/main.py</strong>
                    </div>
                    <p class="folder-description">Punto de entrada de la aplicaci√≥n FastAPI.</p>
                </div>

                <div class="folder-item">
                    <div class="folder-name">
                        <i class="fas fa-database" style="color: #667eea;"></i>
                        <strong>app/db.py</strong>
                    </div>
                    <p class="folder-description">Conexi√≥n a base de datos PostgreSQL con connection pooling.</p>
                </div>

                <div class="folder-item">
                    <div class="folder-name">
                        <i class="fas fa-code" style="color: #f59e0b;"></i>
                        <strong>app/domain.py</strong>
                    </div>
                    <p class="folder-description">Modelos Pydantic y esquemas de request/response.</p>
                </div>
            </div>

            <h2>Integraci√≥n con Base de Datos</h2>
            <p>
                Todos los servicios se conectan a la misma instancia PostgreSQL con esquema normalizado:
            </p>

            <div class="tech-section">
                <h3>Tablas Clave</h3>
                <ul>
                    <li><code>users</code> - Autenticaci√≥n centralizada</li>
                    <li><code>doctors</code> - Perfiles de proveedores de salud</li>
                    <li><code>patients</code> - Informaci√≥n de pacientes</li>
                    <li><code>medical_institutions</code> - Instalaciones de salud</li>
                    <li><code>health_profiles</code> - Datos de salud de pacientes</li>
                    <li><code>emails</code>, <code>phones</code>, <code>addresses</code> - Contacto normalizado</li>
                </ul>

                <h3>Conexi√≥n a Base de Datos</h3>
                <ul>
                    <li>Connection Pooling: SimpleConnectionPool con 1-10 conexiones</li>
                    <li>Context Managers para gesti√≥n autom√°tica de conexiones</li>
                    <li>DictCursor: resultados como diccionarios</li>
                    <li>Manejo completo de errores con logging</li>
                </ul>
            </div>

            <h2>Comunicaci√≥n Inter-Servicios</h2>
            <p>
                Los servicios se comunican mediante APIs HTTP RESTful.
            </p>

            <div class="tech-section">
                <h3>Auth Client Compartido</h3>
                <p>
                    M√≥dulo <code>shared/auth_client.py</code> proporciona creaci√≥n estandarizada de usuarios entre servicios:
                </p>
                <pre><code>from microservices.shared.auth_client import create_user

create_user(email, password, user_type, reference_id)</code></pre>

                <h3>Flujo de Autenticaci√≥n</h3>
                <ol>
                    <li>Usuario se autentica v√≠a auth-jwt-service</li>
                    <li>Token JWT es retornado con informaci√≥n de usuario</li>
                    <li>Otros servicios verifican token v√≠a auth-jwt-service o decodifican localmente</li>
                    <li>Servicios extraen <code>reference_id</code> del token para acceso a entidades</li>
                </ol>
            </div>

            <h2>Principios de Dise√±o API</h2>
            <div>
                <span class="badge">RESTful</span>
                <span class="badge">JSON</span>
                <span class="badge">Pydantic Validation</span>
                <span class="badge">OpenAPI/Swagger</span>
                <span class="badge">HTTP Status Codes</span>
            </div>

            <p class="footer-note">
                <i class="fas fa-info-circle"></i>
                Cada microservicio mantiene responsabilidades de dominio espec√≠ficas mientras comparte infraestructura com√∫n (base de datos, Redis, autenticaci√≥n).
            </p>
        </main>
    </div>
</body>
</html>