<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>PostgreSQL | PredictHealth</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/docs.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <a href="/" class="logo">
                <i class="fas fa-heartbeat"></i>
                PredictHealth Docs
            </a>
            <a href="/docs" class="back-btn">
                <i class="fas fa-arrow-left"></i> Volver
            </a>
        </div>
    </header>

    <!-- Main Container -->
    <div class="docs-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-section">
                <div class="sidebar-title">Introducci贸n</div>
                <ul class="sidebar-links">
                    <li><a href="/docs" class="sidebar-link">Visi贸n General</a></li>
                    <li><a href="/docs/arquitectura" class="sidebar-link">Arquitectura del Sistema</a></li>
                </ul>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-title">Backend</div>
                <ul class="sidebar-links">
                    <li><a href="/docs/backend/flask" class="sidebar-link">Flask API</a></li>
                    <li><a href="/docs/backend/microservicios" class="sidebar-link">Microservicios</a></li>
                    <li><a href="/docs/backend/autenticacion" class="sidebar-link">Autenticaci贸n JWT</a></li>
                </ul>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-title">Frontend</div>
                <ul class="sidebar-links">
                    <li><a href="/docs/frontend/estructura" class="sidebar-link">Estructura</a></li>
                    <li><a href="/docs/frontend/componentes" class="sidebar-link">Componentes</a></li>
                    <li><a href="/docs/frontend/estilos" class="sidebar-link">Estilos y Dise帽o</a></li>
                </ul>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-title">Base de Datos</div>
                <ul class="sidebar-links">
                    <li><a href="/docs/database/postgresql" class="sidebar-link active">PostgreSQL</a></li>
                    <li><a href="/docs/database/redis" class="sidebar-link">Redis Cache</a></li>
                    <li><a href="/docs/database/firebase" class="sidebar-link">Firebase</a></li>
                </ul>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-title">Machine Learning</div>
                <ul class="sidebar-links">
                    <li><a href="/docs/ml/modelos" class="sidebar-link">Modelos Predictivos</a></li>
                    <li><a href="/docs/ml/entrenamiento" class="sidebar-link">Entrenamiento</a></li>
                    <li><a href="/docs/ml/deployment" class="sidebar-link">Despliegue</a></li>
                </ul>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-title">Dispositivos</div>
                <ul class="sidebar-links">
                    <li><a href="/docs/devices/mobile" class="sidebar-link">App M贸vil</a></li>
                    <li><a href="/docs/devices/leap-motion" class="sidebar-link">Leap Motion</a></li>
                </ul>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-title">Deployment</div>
                <ul class="sidebar-links">
                    <li><a href="/docs/deploy/docker" class="sidebar-link">Docker</a></li>
                    <li><a href="/docs/deploy/produccion" class="sidebar-link">Producci贸n</a></li>
                </ul>
            </div>
        </aside>

        <!-- Content -->
        <main class="content">
            <h1 class="page-title">
                <span class="emoji"></span>
                PostgreSQL
            </h1>

            <p class="intro-text">
                Base de datos PostgreSQL 15 para almacenamiento persistente de datos de salud. Esquema normalizado en Tercera Forma Normal (3NF) con procedimientos almacenados, vistas materializadas y optimizaciones de rendimiento.
            </p>

            <h2>Configuraci贸n</h2>
            <div>
                <span class="badge">PostgreSQL 15</span>
                <span class="badge">Base de datos: predicthealth_db</span>
                <span class="badge">Usuario: predictHealth_user</span>
                <span class="badge">Puerto: 5432</span>
                <span class="badge">uuid-ossp</span>
                <span class="badge">pgcrypto</span>
            </div>

            <h2>Esquema de Base de Datos</h2>
            <p>
                Esquema normalizado 3NF con separaci贸n clara de responsabilidades:
            </p>

            <div class="tech-grid">
                <div class="tech-card">
                    <h4><i class="fas fa-users" style="color: #4dd9d6;"></i> Autenticaci贸n</h4>
                    <p>Tabla <code>users</code> centralizada con referencia polim贸rfica mediante <code>user_type</code> y <code>reference_id</code>.</p>
                </div>

                <div class="tech-card">
                    <h4><i class="fas fa-user-md" style="color: #667eea;"></i> Entidades M茅dicas</h4>
                    <p><code>doctors</code>, <code>patients</code>, <code>medical_institutions</code>, <code>health_profiles</code>, <code>doctor_specialties</code>.</p>
                </div>

                <div class="tech-card">
                    <h4><i class="fas fa-envelope" style="color: #f59e0b;"></i> Contacto Normalizado</h4>
                    <p><code>emails</code>, <code>phones</code>, <code>addresses</code> con soporte polim贸rfico para m煤ltiples entidades.</p>
                </div>

                <div class="tech-card">
                    <h4><i class="fas fa-book-medical" style="color: #8b5cf6;"></i> Datos M茅dicos</h4>
                    <p><code>medical_conditions</code>, <code>medications</code>, <code>allergies</code> con relaciones many-to-many.</p>
                </div>

                <div class="tech-card">
                    <h4><i class="fas fa-shield-alt" style="color: #10b981;"></i> Sistema CMS</h4>
                    <p><code>cms_users</code>, <code>cms_roles</code>, <code>cms_permissions</code> para control de acceso basado en roles.</p>
                </div>
            </div>

            <h2>Relaciones Clave</h2>
            <div class="tech-section">
                <h3>Estructura de Relaciones</h3>
                <ul>
                    <li><code>users (1)  (1)</code> entidades de dominio (patients/doctors/institutions)</li>
                    <li><code>patients (N)  (1) doctors</code> - Asociaci贸n m茅dica obligatoria</li>
                    <li><code>patients (N)  (1) medical_institutions</code> - Asociaci贸n institucional obligatoria</li>
                    <li><code>patients (1)  (1) health_profiles</code> - Perfil de salud 煤nico por paciente</li>
                    <li><code>doctors (N)  (1) medical_institutions</code> - Doctores vinculados a instituci贸n</li>
                    <li><code>doctors (N)  (1) doctor_specialties</code> - Especialidades m茅dicas</li>
                </ul>

                <h3>Constraints de Negocio</h3>
                <ul>
                    <li>Pacientes deben tener doctor E instituci贸n (constraint obligatorio)</li>
                    <li>Doctores deben estar vinculados a una instituci贸n (constraint obligatorio)</li>
                    <li>Perfiles de salud son 1:1 con pacientes (constraint 煤nico)</li>
                    <li>Validaci贸n de contacto de emergencia</li>
                    <li>Validaci贸n de l贸gica de consumo de tabaco/alcohol</li>
                </ul>
            </div>

            <h2>Funcionalidades de Base de Datos</h2>

            <div class="tech-section">
                <h3>Procedimientos Almacenados</h3>
                <ul>
                    <li><code>sp_create_patient_with_profile</code> - Registro at贸mico de paciente con creaci贸n de perfil de salud</li>
                    <li><code>sp_get_patient_stats_by_month</code> - Reportes KPI de m茅tricas de pacientes</li>
                    <li><code>sp_get_doctor_performance_stats</code> - M茅tricas de rendimiento de doctores</li>
                    <li><code>sp_get_institution_analytics</code> - An谩lisis y estad铆sticas a nivel de instituci贸n</li>
                </ul>

                <h3>Funciones Helper</h3>
                <ul>
                    <li><code>get_primary_email(entity_type, entity_id)</code> - Obtiene email primario</li>
                    <li><code>add_entity_email(entity_type, entity_id, email, is_primary)</code> - Agrega email</li>
                    <li><code>get_primary_phone(entity_type, entity_id)</code> - Obtiene tel茅fono primario</li>
                    <li><code>add_entity_phone(entity_type, entity_id, phone, is_primary)</code> - Agrega tel茅fono</li>
                    <li><code>get_primary_address(entity_type, entity_id)</code> - Obtiene direcci贸n primaria</li>
                    <li><code>add_entity_address(entity_type, entity_id, address_data)</code> - Agrega direcci贸n</li>
                </ul>

                <h3>Vistas Materializadas</h3>
                <ul>
                    <li><code>vw_patient_demographics</code> - Datos demogr谩ficos con asociaciones</li>
                    <li><code>vw_doctor_performance</code> - M茅tricas de rendimiento de doctores</li>
                    <li><code>vw_monthly_registrations</code> - An谩lisis de registros mensuales</li>
                    <li><code>vw_health_condition_stats</code> - Estad铆sticas de salud poblacional</li>
                    <li><code>vw_dashboard_overview</code> - M茅tricas de resumen general</li>
                    <li><code>vw_doctor_specialty_distribution</code> - Distribuci贸n de especialidades</li>
                    <li><code>vw_geographic_distribution</code> - Distribuci贸n geogr谩fica</li>
                    <li><code>vw_health_condition_prevalence</code> - Prevalencia de condiciones</li>
                    <li><code>vw_patient_validation_status</code> - Estado de validaci贸n de pacientes</li>
                    <li><code>vw_relationship_integrity</code> - Monitoreo de integridad de relaciones</li>
                </ul>
            </div>

            <h2>Optimizaci贸n de Rendimiento</h2>
            <p>
                Estrategias de optimizaci贸n implementadas:
            </p>

            <div class="tech-section">
                <h3>ndices Estrat茅gicos</h3>
                <ul>
                    <li>ndices parciales en registros activos para tablas consultadas frecuentemente</li>
                    <li>ndices compuestos para operaciones de join complejas</li>
                    <li>ndices de claves for谩neas para rendimiento de integridad referencial</li>
                    <li>ndices especializados para filtrado de condiciones de salud</li>
                </ul>

                <h3>Planes de Consulta</h3>
                <ul>
                    <li>Optimizaci贸n mediante 铆ndices estrat茅gicos</li>
                    <li>Vistas materializadas para consultas frecuentes</li>
                    <li>Procedimientos almacenados para operaciones complejas</li>
                </ul>
            </div>

            <h2>Integridad de Datos</h2>
            <div class="tech-section">
                <h3>Constraints de L贸gica de Negocio</h3>
                <ul>
                    <li>Validaci贸n de asociaci贸n de paciente (doctor E instituci贸n)</li>
                    <li>Validaci贸n de consistencia de contacto de emergencia</li>
                    <li>Validaci贸n de l贸gica de consumo de tabaco/alcohol</li>
                    <li>Constraints de validaci贸n de edad y formato</li>
                </ul>

                <h3>Integridad Referencial</h3>
                <ul>
                    <li>Claves for谩neas suaves para asociaciones flexibles</li>
                    <li>Operaciones en cascada para datos dependientes</li>
                    <li>Constraints 煤nicos en campos cr铆ticos de negocio</li>
                </ul>
            </div>

            <h2>Triggers Automatizados</h2>
            <p>
                Funci贸n <code>trigger_set_timestamp()</code> actualiza autom谩ticamente <code>updated_at</code> en todas las tablas relevantes:
            </p>

            <div class="tech-section">
                <h3>Tablas con Triggers</h3>
                <ul>
                    <li><code>patients</code>, <code>doctors</code>, <code>medical_institutions</code></li>
                    <li><code>health_profiles</code>, <code>users</code>, <code>cms_users</code></li>
                    <li><code>emails</code>, <code>phones</code>, <code>addresses</code></li>
                    <li><code>countries</code>, <code>regions</code></li>
                    <li><code>medical_conditions</code>, <code>medications</code>, <code>allergies</code></li>
                </ul>
            </div>

            <h2>Inicializaci贸n</h2>
            <p>
                Script <code>init.sql</code> se ejecuta autom谩ticamente al iniciar el contenedor:
            </p>

            <div class="tech-section">
                <h3>Proceso de Inicializaci贸n</h3>
                <ol>
                    <li>Creaci贸n de extensiones (uuid-ossp, pgcrypto)</li>
                    <li>Creaci贸n de esquema normalizado 3NF completo</li>
                    <li>Constraints y validaci贸n de l贸gica de negocio</li>
                    <li>ndices estrat茅gicos para optimizaci贸n</li>
                    <li>Triggers automatizados para gesti贸n de timestamps</li>
                    <li>Procedimientos almacenados y funciones helper</li>
                    <li>Vistas materializadas para reportes</li>
                    <li>Datos de semilla (especialidades, roles, usuarios de prueba)</li>
                </ol>
            </div>

            <h2>Integraci贸n con Microservicios</h2>
            <p>
                La base de datos sirve a m煤ltiples microservicios con patrones de acceso optimizados:
            </p>

            <div class="tech-section">
                <h3>Servicios que Utilizan PostgreSQL</h3>
                <ul>
                    <li><strong>auth-jwt-service:</strong> Gesti贸n de tokens y autenticaci贸n mediante tabla <code>users</code></li>
                    <li><strong>service-patients:</strong> Gesti贸n del ciclo de vida de pacientes con perfiles de salud</li>
                    <li><strong>service-doctors:</strong> Perfiles de doctores, especialidades y an谩lisis de rendimiento</li>
                    <li><strong>service-institutions:</strong> Gesti贸n de instituciones m茅dicas y an谩lisis geogr谩fico</li>
                    <li><strong>cms-backend:</strong> Funciones administrativas con permisos basados en roles</li>
                    <li><strong>backend-flask:</strong> API Gateway que orquesta acceso a todos los servicios</li>
                </ul>

                <h3>Connection Pooling</h3>
                <ul>
                    <li>SimpleConnectionPool con 1-10 conexiones por servicio</li>
                    <li>Context Managers para gesti贸n autom谩tica de conexiones</li>
                    <li>DictCursor para resultados como diccionarios</li>
                </ul>
            </div>

            <p class="footer-note">
                <i class="fas fa-info-circle"></i>
                El esquema PostgreSQL est谩 dise帽ado para alta disponibilidad, integridad de datos y rendimiento mediante normalizaci贸n, 铆ndices estrat茅gicos y vistas materializadas.
            </p>
        </main>
    </div>
</body>
</html>