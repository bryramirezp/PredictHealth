<!-- /frontend\templates\user_profile.html -->
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Mi Perfil — PredictHealth</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/user_dashboard.css') }}">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
  <!-- Navigation -->
  <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
    <div class="container-fluid">
      <a class="navbar-brand" href="user_dashboard.html">
        <img src="{{ url_for('static', filename='images/logo.jpg') }}" alt="PredictHealth" width="32" height="32" class="me-2">
        <span class="fw-bold text-primary">PredictHealth</span>
      </a>
      
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav me-auto">
          <li class="nav-item">
            <a class="nav-link" href="user_dashboard.html">
              <i class="fas fa-tachometer-alt me-1"></i>Dashboard
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link active" href="user_profile.html">
              <i class="fas fa-user me-1"></i>Perfil
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="lifestyle.html">
              <i class="fas fa-heartbeat me-1"></i>Hábitos
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="measurements.html">
              <i class="fas fa-chart-line me-1"></i>Medidas
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="notifications.html">
              <i class="fas fa-bell me-1"></i>Notificaciones
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="recommendations.html">
              <i class="fas fa-lightbulb me-1"></i>Recomendaciones
            </a>
          </li>
        </ul>
        
        <ul class="navbar-nav">
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
              <i class="fas fa-user-circle me-1"></i>Usuario
            </a>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="register_user.html">Editar Perfil</a></li>
              <li><a class="dropdown-item" href="#">Configuración</a></li>
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item" href="#" id="btnLogout">Cerrar sesión</a></li>
            </ul>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <main class="main-content">
    <div class="container-fluid py-4">
      <!-- Profile Header -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="welcome-card">
            <div class="welcome-content">
              <h1 class="welcome-title">
                <i class="fas fa-user me-2"></i>Mi Perfil
              </h1>
              <p class="welcome-subtitle">Información personal y de salud</p>
            </div>
            <div class="welcome-actions">
              <button class="btn btn-primary" onclick="loadProfile()">
                <i class="fas fa-sync-alt me-1"></i>Actualizar datos
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Profile Content -->
      <div class="row">
        <div class="col-12">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title mb-0">
                <i class="fas fa-user me-2"></i>Información del Perfil
              </h3>
            </div>
            <div class="card-body">
              <!-- Loading State -->
              <div id="profileLoading" class="text-center py-4">
                <i class="fas fa-spinner fa-spin fa-2x text-muted"></i>
                <p class="text-muted mt-2">Cargando perfil...</p>
              </div>

              <!-- Error State -->
              <div id="profileError" class="text-center py-4" style="display: none;">
                <i class="fas fa-exclamation-triangle fa-2x text-warning"></i>
                <p class="text-muted mt-2">Error al cargar perfil</p>
                <button class="btn btn-primary" onclick="loadProfile()">Reintentar</button>
              </div>

              <!-- Profile Content -->
              <div id="profileContent" style="display: none;">
                <!-- Personal Information -->
                <div class="row mb-4">
                  <div class="col-md-6">
                    <h5 class="mb-3">
                      <i class="fas fa-id-card me-2"></i>Información Personal
                    </h5>
                    <div class="row g-3">
                      <div class="col-6">
                        <label class="form-label fw-semibold">Nombre:</label>
                        <p class="form-control-plaintext" id="profileName">-</p>
                      </div>
                      <div class="col-6">
                        <label class="form-label fw-semibold">Apellido:</label>
                        <p class="form-control-plaintext" id="profileLastName">-</p>
                      </div>
                      <div class="col-6">
                        <label class="form-label fw-semibold">Email:</label>
                        <p class="form-control-plaintext" id="profileEmail">-</p>
                      </div>
                      <div class="col-6">
                        <label class="form-label fw-semibold">Fecha de Nacimiento:</label>
                        <p class="form-control-plaintext" id="profileBirthDate">-</p>
                      </div>
                      <div class="col-6">
                        <label class="form-label fw-semibold">Género:</label>
                        <p class="form-control-plaintext" id="profileGender">-</p>
                      </div>
                      <div class="col-6">
                        <label class="form-label fw-semibold">Zona Horaria:</label>
                        <p class="form-control-plaintext" id="profileTimezone">-</p>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <h5 class="mb-3">
                      <i class="fas fa-calendar-alt me-2"></i>Información de Registro
                    </h5>
                    <div class="row g-3">
                      <div class="col-12">
                        <label class="form-label fw-semibold">Fecha de Registro:</label>
                        <p class="form-control-plaintext" id="profileRegistrationDate">-</p>
                      </div>
                      <div class="col-12">
                        <label class="form-label fw-semibold">Última Actualización:</label>
                        <p class="form-control-plaintext" id="profileLastUpdate">-</p>
                      </div>
                      <div class="col-12">
                        <label class="form-label fw-semibold">Estado:</label>
                        <p class="form-control-plaintext" id="profileStatus">-</p>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Health Profile -->
                <div class="row">
                  <div class="col-12">
                    <h5 class="mb-3">
                      <i class="fas fa-heartbeat me-2"></i>Perfil de Salud
                    </h5>
                    <div class="row g-3">
                      <div class="col-md-3">
                        <label class="form-label fw-semibold">Altura:</label>
                        <p class="form-control-plaintext" id="profileHeight">-</p>
                      </div>
                      <div class="col-md-3">
                        <label class="form-label fw-semibold">Peso:</label>
                        <p class="form-control-plaintext" id="profileWeight">-</p>
                      </div>
                      <div class="col-md-3">
                        <label class="form-label fw-semibold">IMC:</label>
                        <p class="form-control-plaintext" id="profileBMI">-</p>
                      </div>
                      <div class="col-md-3">
                        <label class="form-label fw-semibold">Actividad Física:</label>
                        <p class="form-control-plaintext" id="profileActivity">-</p>
                      </div>
                      <div class="col-md-3">
                        <label class="form-label fw-semibold">Fumador:</label>
                        <p class="form-control-plaintext" id="profileSmoker">-</p>
                      </div>
                      <div class="col-md-3">
                        <label class="form-label fw-semibold">Consumo de Alcohol:</label>
                        <p class="form-control-plaintext" id="profileAlcohol">-</p>
                      </div>
                      <div class="col-md-3">
                        <label class="form-label fw-semibold">Hipertensión:</label>
                        <p class="form-control-plaintext" id="profileHypertension">-</p>
                      </div>
                      <div class="col-md-3">
                        <label class="form-label fw-semibold">Colesterol Alto:</label>
                        <p class="form-control-plaintext" id="profileCholesterol">-</p>
                      </div>
                      <div class="col-md-3">
                        <label class="form-label fw-semibold">Antecedente ACV:</label>
                        <p class="form-control-plaintext" id="profileStroke">-</p>
                      </div>
                      <div class="col-md-3">
                        <label class="form-label fw-semibold">Enfermedad Cardíaca:</label>
                        <p class="form-control-plaintext" id="profileHeartDisease">-</p>
                      </div>
                      <div class="col-md-6">
                        <label class="form-label fw-semibold">Notas Adicionales:</label>
                        <p class="form-control-plaintext" id="profileNotes">-</p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Profile functions
    async function loadProfile() {
      try {
        showProfileLoading();
        
        console.log('Loading profile...');
        console.log('Session data:', {
          user_type: '{{ session.get("user_type") }}',
          patient_id: '{{ session.get("patient_id") }}',
          has_token: '{{ session.get("access_token") is not none }}'
        });
        
        // Load personal info
        const profileResponse = await fetch('/api/patient/profile');
        console.log('Profile response status:', profileResponse.status);
        
        if (!profileResponse.ok) {
          const errorText = await profileResponse.text();
          console.error('Profile API error:', errorText);
          throw new Error('Error al cargar perfil personal');
        }
        const profileData = await profileResponse.json();
        console.log('Profile data loaded:', profileData);
        
        // Load health profile
        let healthData = null;
        try {
          const healthResponse = await fetch('/api/patient/health-profile');
          console.log('Health response status:', healthResponse.status);
          
          if (healthResponse.ok) {
            healthData = await healthResponse.json();
            console.log('Health data loaded:', healthData);
          } else {
            const errorText = await healthResponse.text();
            console.error('Health API error:', errorText);
          }
        } catch (error) {
          console.log('Health profile error:', error);
        }
        
        displayProfile(profileData, healthData);
        hideProfileLoading();
        
      } catch (error) {
        console.error('Error loading profile:', error);
        showProfileError();
      }
    }
    
    function showProfileLoading() {
      document.getElementById('profileLoading').style.display = 'block';
      document.getElementById('profileError').style.display = 'none';
      document.getElementById('profileContent').style.display = 'none';
    }
    
    function hideProfileLoading() {
      document.getElementById('profileLoading').style.display = 'none';
    }
    
    function showProfileError() {
      document.getElementById('profileLoading').style.display = 'none';
      document.getElementById('profileError').style.display = 'block';
      document.getElementById('profileContent').style.display = 'none';
    }
    
    function displayProfile(profileData, healthData) {
      // Personal information
      document.getElementById('profileName').textContent = profileData.nombre;
      document.getElementById('profileLastName').textContent = profileData.apellido;
      document.getElementById('profileEmail').textContent = profileData.email;
      document.getElementById('profileBirthDate').textContent = formatDate(profileData.fecha_nacimiento);
      document.getElementById('profileGender').textContent = profileData.genero;
      document.getElementById('profileTimezone').textContent = profileData.zona_horaria || 'America/Mexico_City';
      document.getElementById('profileRegistrationDate').textContent = formatDate(profileData.fecha_creacion);
      document.getElementById('profileLastUpdate').textContent = formatDate(profileData.fecha_actualizacion);
      document.getElementById('profileStatus').textContent = profileData.activo ? 'Activo' : 'Inactivo';
      
      // Health profile
      if (healthData) {
        document.getElementById('profileHeight').textContent = 
          healthData.altura_cm ? `${healthData.altura_cm} cm` : 'No registrado';
        document.getElementById('profileWeight').textContent = 
          healthData.peso_kg ? `${healthData.peso_kg} kg` : 'No registrado';
        
        // Calculate BMI
        if (healthData.altura_cm && healthData.peso_kg) {
          const heightM = healthData.altura_cm / 100;
          const bmi = (healthData.peso_kg / (heightM * heightM)).toFixed(1);
          document.getElementById('profileBMI').textContent = `${bmi} kg/m²`;
        } else {
          document.getElementById('profileBMI').textContent = 'No calculable';
        }
        
        document.getElementById('profileActivity').textContent = 
          healthData.minutos_actividad_fisica_semanal ? 
          `${healthData.minutos_actividad_fisica_semanal} min/semana` : 'No registrado';
        
        document.getElementById('profileSmoker').textContent = 
          healthData.fumador ? 'Sí' : 'No';
        document.getElementById('profileAlcohol').textContent = 
          healthData.consumo_alcohol ? 'Sí' : 'No';
        document.getElementById('profileHypertension').textContent = 
          healthData.diagnostico_hipertension ? 'Sí' : 'No';
        document.getElementById('profileCholesterol').textContent = 
          healthData.diagnostico_colesterol_alto ? 'Sí' : 'No';
        document.getElementById('profileStroke').textContent = 
          healthData.antecedente_acv ? 'Sí' : 'No';
        document.getElementById('profileHeartDisease').textContent = 
          healthData.antecedente_enf_cardiaca ? 'Sí' : 'No';
        document.getElementById('profileNotes').textContent = 
          healthData.condiciones_preexistentes_notas || 'Ninguna';
      } else {
        // No health profile available
        document.getElementById('profileHeight').textContent = 'No registrado';
        document.getElementById('profileWeight').textContent = 'No registrado';
        document.getElementById('profileBMI').textContent = 'No calculable';
        document.getElementById('profileActivity').textContent = 'No registrado';
        document.getElementById('profileSmoker').textContent = 'No';
        document.getElementById('profileAlcohol').textContent = 'No';
        document.getElementById('profileHypertension').textContent = 'No';
        document.getElementById('profileCholesterol').textContent = 'No';
        document.getElementById('profileStroke').textContent = 'No';
        document.getElementById('profileHeartDisease').textContent = 'No';
        document.getElementById('profileNotes').textContent = 'Ninguna';
      }
      
      document.getElementById('profileContent').style.display = 'block';
    }
    
    // Utility function for date formatting
    function formatDate(dateString) {
      if (!dateString) return 'Fecha no disponible';
      
      try {
        const date = new Date(dateString);
        if (isNaN(date.getTime())) return 'Fecha inválida';
        
        return date.toLocaleDateString('es-ES', {
          year: 'numeric',
          month: '2-digit',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit'
        });
      } catch (error) {
        return 'Error al formatear fecha';
      }
    }

    // Initialize profile page
    document.addEventListener('DOMContentLoaded', function() {
      // Load profile data automatically
      loadProfile();
    });

    // Logout functionality
    document.getElementById('btnLogout')?.addEventListener('click', () => {
      fetch('/auth/logout', {method:'POST'})
        .then(response => {
          if (response.ok) {
            window.location.href = 'patient_login.html';
          } else {
            console.error('Error en logout:', response.statusText);
          }
        })
        .catch(error => {
          console.error('Error de conexión en logout:', error);
          // Fallback: redirigir de todas formas
          window.location.href = 'patient_login.html';
        });
    });
  </script>
</body>
</html>
