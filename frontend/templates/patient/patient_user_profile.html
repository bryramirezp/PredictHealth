{% extends "patient/base_patient.html" %}

{% block title %}Mi Perfil — PredictHealth{% endblock %}

{% block breadcrumb %}Mi Perfil{% endblock %}

{% block content %}
<div class="profile-grid">
    <!-- Profile Header -->
    <div class="profile-section">
        <h2 class="section-title">
            <i class="fas fa-user me-2"></i>Mi Perfil
        </h2>
        <p class="section-subtitle">Información personal y de salud</p>
        <button class="btn-primary" onclick="loadProfile()">
            <i class="fas fa-sync-alt me-1"></i>Actualizar datos
        </button>
    </div>

    <!-- Profile Content -->
    <div class="profile-section">
        <h3 class="section-title">
            <i class="fas fa-id-card me-2"></i>Información Personal
        </h3>
        
        <!-- Loading State -->
        <div id="profileLoading" class="loading-state">
            <i class="fas fa-spinner fa-spin"></i>
            <p>Cargando perfil...</p>
        </div>

        <!-- Error State -->
        <div id="profileError" class="error-state" style="display: none;">
            <i class="fas fa-exclamation-triangle"></i>
            <h3>Error al cargar perfil</h3>
            <p>No se pudieron cargar los datos del perfil</p>
            <button class="btn-primary" onclick="loadProfile()">Reintentar</button>
        </div>

        <!-- Profile Content -->
        <div id="profileContent" class="profile-content" style="display: none;">
            <div class="info-grid">
                <div class="info-item">
                    <label>Nombre:</label>
                    <p id="profileName">-</p>
                </div>
                <div class="info-item">
                    <label>Apellido:</label>
                    <p id="profileLastName">-</p>
                </div>
                <div class="info-item">
                    <label>Email:</label>
                    <p id="profileEmail">-</p>
                </div>
                <div class="info-item">
                    <label>Fecha de Nacimiento:</label>
                    <p id="profileBirthDate">-</p>
                </div>
                <div class="info-item">
                    <label>Género:</label>
                    <p id="profileGender">-</p>
                </div>
                <div class="info-item">
                    <label>Zona Horaria:</label>
                    <p id="profileTimezone">-</p>
                </div>
                <div class="info-item">
                    <label>Fecha de Registro:</label>
                    <p id="profileRegistrationDate">-</p>
                </div>
                <div class="info-item">
                    <label>Última Actualización:</label>
                    <p id="profileLastUpdate">-</p>
                </div>
                <div class="info-item">
                    <label>Estado:</label>
                    <p id="profileStatus">-</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Health Profile -->
    <div class="profile-section">
        <h3 class="section-title">
            <i class="fas fa-heartbeat me-2"></i>Perfil de Salud
        </h3>
        <div id="healthContent" class="profile-content" style="display: none;">
            <div class="info-grid">
                <div class="info-item">
                    <label>Altura:</label>
                    <p id="profileHeight">-</p>
                </div>
                <div class="info-item">
                    <label>Peso:</label>
                    <p id="profileWeight">-</p>
                </div>
                <div class="info-item">
                    <label>IMC:</label>
                    <p id="profileBMI">-</p>
                </div>
                <div class="info-item">
                    <label>Actividad Física:</label>
                    <p id="profileActivity">-</p>
                </div>
                <div class="info-item">
                    <label>Fumador:</label>
                    <p id="profileSmoker">-</p>
                </div>
                <div class="info-item">
                    <label>Consumo de Alcohol:</label>
                    <p id="profileAlcohol">-</p>
                </div>
                <div class="info-item">
                    <label>Hipertensión:</label>
                    <p id="profileHypertension">-</p>
                </div>
                <div class="info-item">
                    <label>Colesterol Alto:</label>
                    <p id="profileCholesterol">-</p>
                </div>
                <div class="info-item">
                    <label>Antecedente ACV:</label>
                    <p id="profileStroke">-</p>
                </div>
                <div class="info-item">
                    <label>Enfermedad Cardíaca:</label>
                    <p id="profileHeartDisease">-</p>
                </div>
                <div class="info-item full-width">
                    <label>Notas Adicionales:</label>
                    <p id="profileNotes">-</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts_extra %}
<script>
    // Profile functions
    async function loadProfile() {
        try {
            showProfileLoading();
            
            console.log('Loading profile...');
            
            // Load personal info
            const profileResponse = await fetch('/api/web/patient/profile');
            console.log('Profile response status:', profileResponse.status);
            
            if (!profileResponse.ok) {
                const errorText = await profileResponse.text();
                console.error('Profile API error:', errorText);
                throw new Error('Error al cargar perfil personal');
            }
            const profileData = await profileResponse.json();
            console.log('Profile data loaded:', profileData);
            
            // Load health profile
            let healthData = null;
            try {
                const healthResponse = await fetch('/api/web/patient/health-profile');
                console.log('Health response status:', healthResponse.status);
                
                if (healthResponse.ok) {
                    healthData = await healthResponse.json();
                    console.log('Health data loaded:', healthData);
                } else {
                    const errorText = await healthResponse.text();
                    console.error('Health API error:', errorText);
                }
            } catch (error) {
                console.log('Health profile error:', error);
            }
            
            displayProfile(profileData, healthData);
            hideProfileLoading();
            
        } catch (error) {
            console.error('Error loading profile:', error);
            showProfileError();
        }
    }
    
    function showProfileLoading() {
        document.getElementById('profileLoading').style.display = 'block';
        document.getElementById('profileError').style.display = 'none';
        document.getElementById('profileContent').style.display = 'none';
        document.getElementById('healthContent').style.display = 'none';
    }
    
    function hideProfileLoading() {
        document.getElementById('profileLoading').style.display = 'none';
    }
    
    function showProfileError() {
        document.getElementById('profileLoading').style.display = 'none';
        document.getElementById('profileError').style.display = 'block';
        document.getElementById('profileContent').style.display = 'none';
        document.getElementById('healthContent').style.display = 'none';
    }
    
    function displayProfile(profileData, healthData) {
        // Personal information
        if (profileData.patient) {
            document.getElementById('profileName').textContent = profileData.patient.nombre;
            document.getElementById('profileLastName').textContent = profileData.patient.apellido;
            document.getElementById('profileEmail').textContent = profileData.patient.email;
            document.getElementById('profileBirthDate').textContent = formatDate(profileData.patient.fecha_nacimiento);
            document.getElementById('profileGender').textContent = profileData.patient.genero;
            document.getElementById('profileTimezone').textContent = profileData.patient.zona_horaria || 'America/Mexico_City';
            document.getElementById('profileRegistrationDate').textContent = formatDate(profileData.patient.fecha_creacion);
            document.getElementById('profileLastUpdate').textContent = formatDate(profileData.patient.fecha_actualizacion);
            document.getElementById('profileStatus').textContent = profileData.patient.activo ? 'Activo' : 'Inactivo';
        }
        
        // Health profile
        if (healthData) {
            document.getElementById('profileHeight').textContent =
                healthData.altura_cm ? `${healthData.altura_cm} cm` : 'No registrado';
            document.getElementById('profileWeight').textContent =
                healthData.peso_kg ? `${healthData.peso_kg} kg` : 'No registrado';
            
            // Calculate BMI
            if (healthData.altura_cm && healthData.peso_kg) {
                const heightM = healthData.altura_cm / 100;
                const bmi = (healthData.peso_kg / (heightM * heightM)).toFixed(1);
                document.getElementById('profileBMI').textContent = `${bmi} kg/m²`;
            } else {
                document.getElementById('profileBMI').textContent = 'No calculable';
            }
            
            document.getElementById('profileActivity').textContent =
                healthData.minutos_actividad_fisica_semanal ?
                `${healthData.minutos_actividad_fisica_semanal} min/semana` : 'No registrado';
            
            document.getElementById('profileSmoker').textContent =
                healthData.fumador ? 'Sí' : 'No';
            document.getElementById('profileAlcohol').textContent =
                healthData.consumo_alcohol ? 'Sí' : 'No';
            document.getElementById('profileHypertension').textContent =
                healthData.diagnostico_hipertension ? 'Sí' : 'No';
            document.getElementById('profileCholesterol').textContent =
                healthData.diagnostico_colesterol_alto ? 'Sí' : 'No';
            document.getElementById('profileStroke').textContent =
                healthData.antecedente_acv ? 'Sí' : 'No';
            document.getElementById('profileHeartDisease').textContent =
                healthData.antecedente_enf_cardiaca ? 'Sí' : 'No';
            document.getElementById('profileNotes').textContent =
                healthData.condiciones_preexistentes_notas || 'Ninguna';
        } else {
            // No health profile available
            document.getElementById('profileHeight').textContent = 'No registrado';
            document.getElementById('profileWeight').textContent = 'No registrado';
            document.getElementById('profileBMI').textContent = 'No calculable';
            document.getElementById('profileActivity').textContent = 'No registrado';
            document.getElementById('profileSmoker').textContent = 'No';
            document.getElementById('profileAlcohol').textContent = 'No';
            document.getElementById('profileHypertension').textContent = 'No';
            document.getElementById('profileCholesterol').textContent = 'No';
            document.getElementById('profileStroke').textContent = 'No';
            document.getElementById('profileHeartDisease').textContent = 'No';
            document.getElementById('profileNotes').textContent = 'Ninguna';
        }
        
        document.getElementById('profileContent').style.display = 'block';
        document.getElementById('healthContent').style.display = 'block';
    }
    
    // Utility function for date formatting
    function formatDate(dateString) {
        if (!dateString) return 'Fecha no disponible';
        
        try {
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return 'Fecha inválida';
            
            return date.toLocaleDateString('es-ES', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        } catch (error) {
            return 'Error al formatear fecha';
        }
    }

    // Initialize profile page
    document.addEventListener('DOMContentLoaded', function() {
        // Load profile data automatically
        loadProfile();
    });
</script>
{% endblock %}
