{% extends "patient/base_patient.html" %}

{% block title %}PredictHealth - Dashboard del Paciente{% endblock %}

{% block breadcrumb %}Inicio{% endblock %}

{% block content %}

        <div class="welcome-section">
            <h1 class="welcome-title" id="dashboard-welcome-title">¡Hola, Paciente!</h1>
            <p class="welcome-subtitle">Tu próxima cita médica es el 15 de Noviembre a las 10:00 AM</p>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-icon appointments">
                        <i class="fas fa-calendar-check"></i>
                    </div>
                </div>
                <div class="stat-number" id="appointments-count">...</div>
                <div class="stat-label">Citas Programadas</div>
            </div>

            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-icon medications">
                        <i class="fas fa-pills"></i>
                    </div>
                </div>
                <div class="stat-number" id="medications-count">...</div>
                <div class="stat-label">Medicamentos de Hoy</div>
            </div>

            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-icon alerts">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                </div>
                <div class="stat-number" id="alerts-count">...</div>
                <div class="stat-label">Novedades</div>
            </div>

            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-icon health">
                        <i class="fas fa-heartbeat"></i>
                    </div>
                </div>
                <div class="stat-number" id="health-score">...</div>
                <div class="stat-label">Puntuación de Salud</div>
            </div>
        </div>

        <div class="main-content">
            <div class="left-content">
                <div class="activities">
                    <h1>
                        <i class="fas fa-star"></i>
                        Actividades Populares
                    </h1>
                    <div class="activity-container">
                        <div class="image-container img-one" data-url="{{ url_for('patient.patient_measurements_page') }}">
                            <img src="https://images.unsplash.com/photo-1571019613454-1cb2f99b2d8b?w=400&h=300&fit=crop" alt="Mediciones" />
                            <div class="overlay">
                                <h3>Mediciones</h3>
                            </div>
                        </div>
                        <div class="image-container img-two" data-url="{{ url_for('patient.patient_lifestyle_page') }}">
                            <img src="https://images.unsplash.com/photo-1559757148-5c350d0d3c56?w=400&h=300&fit=crop" alt="Estilo de Vida" />
                            <div class="overlay">
                                <h3>Estilo de Vida</h3>
                            </div>
                        </div>
                        <div class="image-container img-three" data-url="{{ url_for('patient.patient_appointments_page') }}">
                            <img src="https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=400&h=300&fit=crop" alt="Citas Médicas" />
                            <div class="overlay">
                                <h3>Citas Médicas</h3>
                            </div>
                        </div>
                        <div class="image-container img-four" data-url="{{ url_for('patient.patient_recommendations_page') }}">
                            <img src="https://images.unsplash.com/photo-1559757175-0eb30cd8c063?w=400&h=300&fit=crop" alt="Recomendaciones" />
                            <div class="overlay">
                                <h3>Recomendaciones</h3>
                            </div>
                        </div>
                        <div class="image-container img-five" data-url="{{ url_for('patient.patient_notifications_page') }}">
                            <img src="https://images.unsplash.com/photo-1576091160399-112ba8d25d1f?w=400&h=300&fit=crop" alt="Notificaciones" />
                            <div class="overlay">
                                <h3>Notificaciones</h3>
                            </div>
                        </div>
                        <div class="image-container img-six" data-url="{{ url_for('patient.patient_profile_page') }}">
                            <img src="https://images.unsplash.com/photo-1559757148-5c350d0d3c56?w=400&h=300&fit=crop" alt="Perfil" />
                            <div class="overlay">
                                <h3>Perfil</h3>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="weekly-schedule">
                    <h1>
                        <i class="fas fa-calendar-week"></i>
                        Calendario Semanal
                    </h1>
                    <div class="calendar">
                        <div class="day-and-activity activity-one">
                            <div class="day">
                                <h1>15</h1>
                                <p>lun</p>
                            </div>
                            <div class="activity">
                                <h2>Cita con Dr. García</h2>
                                <div class="participants">
                                    <img src="https://images.unsplash.com/photo-1612349317150-e413f6a5b16d?w=30&h=30&fit=crop&crop=face" style="--i: 1" alt="" />
                                </div>
                            </div>
                            <button class="btn">Ver Detalles</button>
                        </div>

                        <div class="day-and-activity activity-two">
                            <div class="day">
                                <h1>17</h1>
                                <p>mié</p>
                            </div>
                            <div class="activity">
                                <h2>Mediciones Diarias</h2>
                                <div class="participants">
                                    <img src="https://images.unsplash.com/photo-1438761681033-6461ffad8d80?w=30&h=30&fit=crop&crop=face" style="--i: 1" alt="" />
                                </div>
                            </div>
                            <button class="btn">Registrar</button>
                        </div>

                        <div class="day-and-activity activity-three">
                            <div class="day">
                                <h1>20</h1>
                                <p>sáb</p>
                            </div>
                            <div class="activity">
                                <h2>Chequeo General</h2>
                                <div class="participants">
                                    <img src="https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=30&h=30&fit=crop&crop=face" style="--i: 1" alt="" />
                                </div>
                            </div>
                            <button class="btn">Confirmar</button>
                        </div>
                    </div>
                </div>

                <div class="personal-bests">
                    <h1>
                        <i class="fas fa-trophy"></i>
                        Logros de Salud
                    </h1>
                    <div class="personal-bests-container">
                        <div class="best-item box-one">
                            <p>7 días consecutivos de mediciones</p>
                            <img src="https://images.unsplash.com/photo-1571019613454-1cb2f99b2d8b?w=40&h=40&fit=crop" alt="" />
                        </div>
                        <div class="best-item box-two">
                            <p>Meta de ejercicio cumplida esta semana</p>
                            <img src="https://images.unsplash.com/photo-1571019613454-1cb2f99b2d8b?w=40&h=40&fit=crop" alt="" />
                        </div>
                        <div class="best-item box-three">
                            <p>Primera consulta virtual completada</p>
                            <img src="https://images.unsplash.com/photo-1571019613454-1cb2f99b2d8b?w=40&h=40&fit=crop" alt="" />
                        </div>
                    </div>
                </div>
            </div>

            <div class="right-content">
                <div class="user-info">
                    <div class="icon-container">
                        <i class="fa fa-bell nav-icon"></i>
                        <i class="fa fa-message nav-icon"></i>
                    </div>
                    <h4 id="dashboard-user-name">Paciente</h4>
                    <img src="https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=50&h=50&fit=crop&crop=face" alt="user" />
                </div>

                <div class="active-calories">
                    <h1>Actividad Física</h1>
                    <div class="active-calories-container">
                        <div class="box" style="--i: 85%">
                            <div class="circle">
                                <h2>85<small>%</small></h2>
                            </div>
                        </div>
                        <div class="calories-content">
                            <p><span>Hoy:</span> 2,400 pasos</p>
                            <p><span>Esta Semana:</span> 15,000 pasos</p>
                            <p><span>Meta Semanal:</span> 70,000 pasos</p>
                        </div>
                    </div>
                </div>

                <div class="mobile-personal-bests">
                    <h1>Logros de Salud</h1>
                    <div class="personal-bests-container">
                        <div class="best-item box-one">
                            <p>7 días consecutivos de mediciones</p>
                            <img src="https://images.unsplash.com/photo-1571019613454-1cb2f99b2d8b?w=40&h=40&fit=crop" alt="" />
                        </div>
                        <div class="best-item box-two">
                            <p>Meta de ejercicio cumplida esta semana</p>
                            <img src="https://images.unsplash.com/photo-1571019613454-1cb2f99b2d8b?w=40&h=40&fit=crop" alt="" />
                        </div>
                        <div class="best-item box-three">
                            <p>Primera consulta virtual completada</p>
                            <img src="https://images.unsplash.com/photo-1571019613454-1cb2f99b2d8b?w=40&h=40&fit=crop" alt="" />
                        </div>
                    </div>
                </div>

                <div class="friends-activity">
                    <h1>Actividad Reciente</h1>
                    <div class="card-container">
                        <div class="card">
                            <div class="card-user-info">
                                <img src="https://images.unsplash.com/photo-1612349317150-e413f6a5b16d?w=35&h=35&fit=crop&crop=face" alt="" />
                                <h2>Dr. García</h2>
                            </div>
                            <img class="card-img" src="https://images.unsplash.com/photo-1559757148-5c350d0d3c56?w=300&h=120&fit=crop" alt="" />
                            <p>Resultados de laboratorio disponibles. ¡Todo en orden! ✓</p>
                        </div>

                        <div class="card card-two">
                            <div class="card-user-info">
                                <img src="https://images.unsplash.com/photo-1438761681033-6461ffad8d80?w=35&h=35&fit=crop&crop=face" alt="" />
                                <h2>Sistema</h2>
                            </div>
                            <img class="card-img" src="https://images.unsplash.com/photo-1559757175-0eb30cd8c063?w=300&h=120&fit=crop" alt="" />
                            <p>¡Felicitaciones! Has completado 7 días de mediciones consecutivas.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
{% endblock %}

{% block scripts_extra %}
<script>
    // Navigation functionality
    document.addEventListener('DOMContentLoaded', function() {
        
        // --- MODIFICADO ---
        // Handle activity clicks using data-url
        document.querySelectorAll('.image-container').forEach(activity => {
            activity.addEventListener('click', function() {
                const url = this.dataset.url;
                if (url) {
                    window.location.href = url;
                } else {
                    console.warn('No data-url attribute found for this activity.');
                }
            });
        });

        // Handle calendar buttons
        const calendarBtns = document.querySelectorAll('.btn');
        calendarBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const activity = this.parentElement.querySelector('.activity h2').textContent;
                console.log('Calendar action:', activity);

                // Add specific actions based on activity type
                if (activity.includes('Cita con Dr.')) {
                    // Open appointment details
                    alert('Abriendo detalles de la cita...');
                } else if (activity.includes('Mediciones')) {
                    // Reemplaza esto con tu ruta real de Flask
                    window.location.href = "{{ url_for('patient.patient_measurements_page') }}";
                } else if (activity.includes('Chequeo')) {
                    alert('Confirmando cita...');
                }
            });
        });

        // Load dashboard data
        loadDashboardData();
    });

    // Load dashboard data from API
    async function loadDashboardData() {
        try {
            const response = await fetch('/api/web/patient/dashboard', {
                method: 'GET',
                headers: {
                    'Accept': 'application/json'
                },
                credentials: 'include'
            });

            if (response.ok) {
                const data = await response.json();
                updateDashboard(data.data);
            } else if (response.status === 401) {
                window.location.href = '/patient_login.html';
            } else {
                console.error('Error loading dashboard:', response.status);
                // --- AÑADIDO ---
                showError('No se pudieron cargar los datos del dashboard.');
            }
        } catch (error) {
            console.error('Error:', error);
            // --- AÑADIDO ---
            showError('Error de conexión. No se pudieron cargar los datos.');
        }
    }

    // Update dashboard with real data
    function updateDashboard(data) {
        if (!data) return;

        // Update statistics
        const appointmentsCount = document.getElementById('appointments-count');
        const medicationsCount = document.getElementById('medications-count');
        const alertsCount = document.getElementById('alerts-count');
        const healthScore = document.getElementById('health-score');

        // Usamos || para mantener los datos de demo si la API no los trae
        if (appointmentsCount) appointmentsCount.textContent = data.statistics?.total_appointments || 2;
        if (medicationsCount) medicationsCount.textContent = data.statistics?.total_medications || 3;
        if (alertsCount) alertsCount.textContent = data.statistics?.total_alerts || 1;
        if (healthScore) healthScore.textContent = data.statistics?.health_score || 85;

        // --- AÑADIDO / MODIFICADO ---
        // Actualizar nombres de usuario
        const patientName = data.patient?.name || 'Paciente';
        const patientFullName = `${data.patient?.name || 'Carlos'} ${data.patient?.last_name || 'Rodríguez'}`;

        // 1. Actualiza el saludo del dashboard
        const welcomeTitle = document.getElementById('dashboard-welcome-title');
        if (welcomeTitle) {
            welcomeTitle.textContent = `¡Hola, ${patientName}!`;
        }

        // 2. Actualiza el nombre en la tarjeta de usuario
        const userNameCard = document.getElementById('dashboard-user-name');
        if (userNameCard) {
            userNameCard.textContent = patientFullName;
        }

        // 3. Actualiza el nombre en el sidebar (de base_patient.html)
        const patientNameElement = document.getElementById('patientName');
        if (patientNameElement) {
            patientNameElement.textContent = patientFullName;
        }
        
        // 4. Actualiza el saludo en el top-bar (de base_patient.html)
        const patientGreetingElement = document.getElementById('patientGreeting');
        if (patientGreetingElement) {
            patientGreetingElement.textContent = `Hola, ${patientName}`;
        }
    }

    // Error display function
    function showError(message) {
        const errorDiv = document.createElement('div');
        // Puedes darle estilos a esta clase '.dashboard-error' en tu CSS
        errorDiv.className = 'dashboard-error'; 
        errorDiv.style.cssText = 'background-color: #f8d7da; color: #721c24; padding: 1rem; border: 1px solid #f5c6cb; border-radius: 8px; margin-bottom: 1.5rem; display: flex; align-items: center;';
        
        errorDiv.innerHTML = `
            <i class="fas fa-exclamation-circle" style="margin-right: 10px;"></i>
            ${message}
        `;

        // Inserta el error después del 'breadcrumb-nav'
        const breadcrumbNav = document.querySelector('.breadcrumb-nav');
        if (breadcrumbNav) {
            breadcrumbNav.insertAdjacentElement('afterend', errorDiv);
        } else {
            // Fallback si no encuentra el breadcrumb
            const content = document.getElementById('content');
            content.insertBefore(errorDiv, content.firstChild);
        }

        setTimeout(() => {
            if (errorDiv) errorDiv.remove();
        }, 5000);
    }
</script>
{% endblock %}