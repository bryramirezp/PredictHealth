<!-- /frontend\templates\patient_dashboard.html -->
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PredictHealth - Dashboard del Paciente</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/patient_dashboard.css') }}">
</head>
<body>
    <!-- Mobile Menu Button -->
    <button class="mobile-menu-btn" onclick="toggleMobileMenu()">
        <i class="fas fa-bars"></i>
    </button>

    <!-- Sidebar Navigation -->
    <nav class="main-menu" id="mainMenu">
        <h1>
            <i class="fas fa-heartbeat"></i>
            PredictHealth
        </h1>
        <ul>
            <li class="nav-item active">
                <b></b>
                <b></b>
                <a href="#home">
                    <i class="fa fa-house nav-icon"></i>
                    <span class="nav-text">Inicio</span>
                </a>
            </li>
            <li class="nav-item">
                <b></b>
                <b></b>
                <a href="#medical-record">
                    <i class="fa fa-file-medical nav-icon"></i>
                    <span class="nav-text">Mi Expediente</span>
                </a>
            </li>
            <li class="nav-item">
                <b></b>
                <b></b>
                <a href="#appointments">
                    <i class="fa fa-calendar-check nav-icon"></i>
                    <span class="nav-text">Mis Citas</span>
                </a>
            </li>
            <li class="nav-item">
                <b></b>
                <b></b>
                <a href="#profile">
                    <i class="fa fa-user nav-icon"></i>
                    <span class="nav-text">Perfil</span>
                </a>
            </li>
        </ul>
    </nav>

    <!-- Main Content -->
    <section class="content" id="content">
        <!-- Top Bar -->
        <div class="top-bar">
            <div class="patient-info">
                <span class="patient-name" id="patientName">Hola, Carlos</span>
                <span class="patient-type">Portal del Paciente</span>
            </div>
            <button class="logout-btn" onclick="handleLogout()">
                <i class="fas fa-sign-out-alt"></i>
                Cerrar Sesión
            </button>
        </div>

        <!-- Welcome Section -->
        <div class="welcome-section">
            <h1 class="welcome-title">¡Hola, Carlos!</h1>
            <p class="welcome-subtitle">Tu próxima cita médica es el 15 de Noviembre a las 10:00 AM</p>
        </div>

        <!-- Stats Grid -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-icon appointments">
                        <i class="fas fa-calendar-check"></i>
                    </div>
                </div>
                <div class="stat-number" id="appointments-count">2</div>
                <div class="stat-label">Citas Programadas</div>
            </div>

            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-icon medications">
                        <i class="fas fa-pills"></i>
                    </div>
                </div>
                <div class="stat-number" id="medications-count">3</div>
                <div class="stat-label">Medicamentos de Hoy</div>
            </div>

            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-icon alerts">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                </div>
                <div class="stat-number" id="alerts-count">1</div>
                <div class="stat-label">Novedades</div>
            </div>

            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-icon health">
                        <i class="fas fa-heartbeat"></i>
                    </div>
                </div>
                <div class="stat-number" id="health-score">85</div>
                <div class="stat-label">Puntuación de Salud</div>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="main-content">
            <!-- Left Content -->
            <div class="left-content">
                <!-- Popular Activities -->
                <div class="activities">
                    <h1>
                        <i class="fas fa-star"></i>
                        Actividades Populares
                    </h1>
                    <div class="activity-container">
                        <div class="image-container img-one">
                            <img src="https://images.unsplash.com/photo-1571019613454-1cb2f99b2d8b?w=400&h=300&fit=crop" alt="Mediciones" />
                            <div class="overlay">
                                <h3>Mediciones</h3>
                            </div>
                        </div>
                        <div class="image-container img-two">
                            <img src="https://images.unsplash.com/photo-1559757148-5c350d0d3c56?w=400&h=300&fit=crop" alt="Estilo de Vida" />
                            <div class="overlay">
                                <h3>Estilo de Vida</h3>
                            </div>
                        </div>
                        <div class="image-container img-three">
                            <img src="https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=400&h=300&fit=crop" alt="Citas Médicas" />
                            <div class="overlay">
                                <h3>Citas Médicas</h3>
                            </div>
                        </div>
                        <div class="image-container img-four">
                            <img src="https://images.unsplash.com/photo-1559757175-0eb30cd8c063?w=400&h=300&fit=crop" alt="Recomendaciones" />
                            <div class="overlay">
                                <h3>Recomendaciones</h3>
                            </div>
                        </div>
                        <div class="image-container img-five">
                            <img src="https://images.unsplash.com/photo-1576091160399-112ba8d25d1f?w=400&h=300&fit=crop" alt="Notificaciones" />
                            <div class="overlay">
                                <h3>Notificaciones</h3>
                            </div>
                        </div>
                        <div class="image-container img-six">
                            <img src="https://images.unsplash.com/photo-1559757148-5c350d0d3c56?w=400&h=300&fit=crop" alt="Perfil" />
                            <div class="overlay">
                                <h3>Perfil</h3>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Weekly Schedule -->
                <div class="weekly-schedule">
                    <h1>
                        <i class="fas fa-calendar-week"></i>
                        Calendario Semanal
                    </h1>
                    <div class="calendar">
                        <div class="day-and-activity activity-one">
                            <div class="day">
                                <h1>15</h1>
                                <p>lun</p>
                            </div>
                            <div class="activity">
                                <h2>Cita con Dr. García</h2>
                                <div class="participants">
                                    <img src="https://images.unsplash.com/photo-1612349317150-e413f6a5b16d?w=30&h=30&fit=crop&crop=face" style="--i: 1" alt="" />
                                </div>
                            </div>
                            <button class="btn">Ver Detalles</button>
                        </div>

                        <div class="day-and-activity activity-two">
                            <div class="day">
                                <h1>17</h1>
                                <p>mié</p>
                            </div>
                            <div class="activity">
                                <h2>Mediciones Diarias</h2>
                                <div class="participants">
                                    <img src="https://images.unsplash.com/photo-1438761681033-6461ffad8d80?w=30&h=30&fit=crop&crop=face" style="--i: 1" alt="" />
                                </div>
                            </div>
                            <button class="btn">Registrar</button>
                        </div>

                        <div class="day-and-activity activity-three">
                            <div class="day">
                                <h1>20</h1>
                                <p>sáb</p>
                            </div>
                            <div class="activity">
                                <h2>Chequeo General</h2>
                                <div class="participants">
                                    <img src="https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=30&h=30&fit=crop&crop=face" style="--i: 1" alt="" />
                                </div>
                            </div>
                            <button class="btn">Confirmar</button>
                        </div>
                    </div>
                </div>

                <!-- Personal Bests -->
                <div class="personal-bests">
                    <h1>
                        <i class="fas fa-trophy"></i>
                        Logros de Salud
                    </h1>
                    <div class="personal-bests-container">
                        <div class="best-item box-one">
                            <p>7 días consecutivos de mediciones</p>
                            <img src="https://images.unsplash.com/photo-1571019613454-1cb2f99b2d8b?w=40&h=40&fit=crop" alt="" />
                        </div>
                        <div class="best-item box-two">
                            <p>Meta de ejercicio cumplida esta semana</p>
                            <img src="https://images.unsplash.com/photo-1571019613454-1cb2f99b2d8b?w=40&h=40&fit=crop" alt="" />
                        </div>
                        <div class="best-item box-three">
                            <p>Primera consulta virtual completada</p>
                            <img src="https://images.unsplash.com/photo-1571019613454-1cb2f99b2d8b?w=40&h=40&fit=crop" alt="" />
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Content -->
            <div class="right-content">
                <!-- User Info -->
                <div class="user-info">
                    <div class="icon-container">
                        <i class="fa fa-bell nav-icon"></i>
                        <i class="fa fa-message nav-icon"></i>
                    </div>
                    <h4>Carlos Rodríguez</h4>
                    <img src="https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=50&h=50&fit=crop&crop=face" alt="user" />
                </div>

                <!-- Active Calories -->
                <div class="active-calories">
                    <h1>Actividad Física</h1>
                    <div class="active-calories-container">
                        <div class="box" style="--i: 85%">
                            <div class="circle">
                                <h2>85<small>%</small></h2>
                            </div>
                        </div>
                        <div class="calories-content">
                            <p><span>Hoy:</span> 2,400 pasos</p>
                            <p><span>Esta Semana:</span> 15,000 pasos</p>
                            <p><span>Meta Semanal:</span> 70,000 pasos</p>
                        </div>
                    </div>
                </div>

                <!-- Mobile Personal Bests -->
                <div class="mobile-personal-bests">
                    <h1>Logros de Salud</h1>
                    <div class="personal-bests-container">
                        <div class="best-item box-one">
                            <p>7 días consecutivos de mediciones</p>
                            <img src="https://images.unsplash.com/photo-1571019613454-1cb2f99b2d8b?w=40&h=40&fit=crop" alt="" />
                        </div>
                        <div class="best-item box-two">
                            <p>Meta de ejercicio cumplida esta semana</p>
                            <img src="https://images.unsplash.com/photo-1571019613454-1cb2f99b2d8b?w=40&h=40&fit=crop" alt="" />
                        </div>
                        <div class="best-item box-three">
                            <p>Primera consulta virtual completada</p>
                            <img src="https://images.unsplash.com/photo-1571019613454-1cb2f99b2d8b?w=40&h=40&fit=crop" alt="" />
                        </div>
                    </div>
                </div>

                <!-- Friends Activity -->
                <div class="friends-activity">
                    <h1>Actividad Reciente</h1>
                    <div class="card-container">
                        <div class="card">
                            <div class="card-user-info">
                                <img src="https://images.unsplash.com/photo-1612349317150-e413f6a5b16d?w=35&h=35&fit=crop&crop=face" alt="" />
                                <h2>Dr. García</h2>
                            </div>
                            <img class="card-img" src="https://images.unsplash.com/photo-1559757148-5c350d0d3c56?w=300&h=120&fit=crop" alt="" />
                            <p>Resultados de laboratorio disponibles. ¡Todo en orden! 🩺✅</p>
                        </div>

                        <div class="card card-two">
                            <div class="card-user-info">
                                <img src="https://images.unsplash.com/photo-1438761681033-6461ffad8d80?w=35&h=35&fit=crop&crop=face" alt="" />
                                <h2>Sistema</h2>
                            </div>
                            <img class="card-img" src="https://images.unsplash.com/photo-1559757175-0eb30cd8c063?w=300&h=120&fit=crop" alt="" />
                            <p>¡Felicitaciones! Has completado 7 días de mediciones consecutivas. 🎉</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <script src="{{ url_for('static', filename='js/auth-manager.js') }}"></script>
    <script>
        // Mobile menu functionality
        function toggleMobileMenu() {
            const menu = document.getElementById('mainMenu');
            const content = document.getElementById('content');

            menu.classList.toggle('show');
            content.classList.toggle('mobile-menu-open');
        }

        // Navigation functionality
        document.addEventListener('DOMContentLoaded', function() {
            // Handle navigation clicks
            const navItems = document.querySelectorAll('.nav-item a');
            navItems.forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();

                    // Remove active class from all items
                    navItems.forEach(nav => nav.parentElement.classList.remove('active'));

                    // Add active class to clicked item
                    this.parentElement.classList.add('active');

                    // Close mobile menu if open
                    const menu = document.getElementById('mainMenu');
                    const content = document.getElementById('content');
                    menu.classList.remove('show');
                    content.classList.remove('mobile-menu-open');

                    // Handle navigation (you can add routing logic here)
                    const href = this.getAttribute('href');
                    console.log('Navigate to:', href);
                });
            });

            // Handle activity clicks
            const activities = document.querySelectorAll('.image-container');
            activities.forEach(activity => {
                activity.addEventListener('click', function() {
                    const title = this.querySelector('.overlay h3').textContent;
                    console.log('Activity clicked:', title);

                    // Add navigation logic based on activity type
                    switch(title.toLowerCase()) {
                        case 'mediciones':
                            window.location.href = '/patient/measurements.html';
                            break;
                        case 'estilo de vida':
                            window.location.href = '/patient/lifestyle.html';
                            break;
                        case 'citas médicas':
                            window.location.href = '/patient/appointments.html';
                            break;
                        case 'recomendaciones':
                            window.location.href = '/patient/recommendations.html';
                            break;
                        case 'notificaciones':
                            window.location.href = '/patient/notifications.html';
                            break;
                        case 'perfil':
                            window.location.href = '/patient/user_profile.html';
                            break;
                    }
                });
            });

            // Handle calendar buttons
            const calendarBtns = document.querySelectorAll('.btn');
            calendarBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const activity = this.parentElement.querySelector('.activity h2').textContent;
                    console.log('Calendar action:', activity);

                    // Add specific actions based on activity type
                    if (activity.includes('Cita con Dr.')) {
                        // Open appointment details
                        alert('Abriendo detalles de la cita...');
                    } else if (activity.includes('Mediciones')) {
                        window.location.href = '/patient/measurements.html';
                    } else if (activity.includes('Chequeo')) {
                        alert('Confirmando cita...');
                    }
                });
            });

            // Load user data
            loadUserData();
        });

        // Load user data and initialize dashboard
        async function loadUserData() {
            try {
                // Check authentication
                const isLoggedIn = await authManager.isLoggedIn();
                if (!isLoggedIn) {
                    window.location.href = '/patient_login.html';
                    return;
                }

                const userInfo = await authManager.getUserInfo();
                if (userInfo.user_type !== 'patient') {
                    window.location.href = '/';
                    return;
                }

                // Update user info in UI
                const patientNameElement = document.getElementById('patientName');
                if (patientNameElement) {
                    patientNameElement.textContent = `Hola, ${userInfo.name || userInfo.email || 'Paciente'}`;
                }

                // Load dashboard data
                await loadDashboardData();

            } catch (error) {
                console.error('Error loading user data:', error);
                showError('Error cargando datos del usuario');
            }
        }

        // Load dashboard data from API
        async function loadDashboardData() {
            try {
                const response = await fetch('/api/web/patient/dashboard', {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    },
                    credentials: 'include'
                });

                if (response.ok) {
                    const data = await response.json();
                    updateDashboard(data.data);
                } else if (response.status === 401) {
                    window.location.href = '/patient_login.html';
                } else {
                    console.error('Error loading dashboard:', response.status);
                    // Keep default demo data
                }
            } catch (error) {
                console.error('Error:', error);
                // Keep default demo data
            }
        }

        // Update dashboard with real data
        function updateDashboard(data) {
            if (!data) return;

            // Update statistics
            const appointmentsCount = document.getElementById('appointments-count');
            const medicationsCount = document.getElementById('medications-count');
            const alertsCount = document.getElementById('alerts-count');
            const healthScore = document.getElementById('health-score');

            if (appointmentsCount) appointmentsCount.textContent = data.statistics?.total_appointments || 2;
            if (medicationsCount) medicationsCount.textContent = data.statistics?.total_medications || 3;
            if (alertsCount) alertsCount.textContent = data.statistics?.total_alerts || 1;
            if (healthScore) healthScore.textContent = data.statistics?.health_score || 85;

            // Update user name
            const patientNameElement = document.getElementById('patientName');
            if (patientNameElement && data.patient) {
                patientNameElement.textContent = `Hola, ${data.patient.name || 'Carlos'}`;
            }
        }

        // Logout functionality
        async function handleLogout() {
            if (confirm('¿Estás seguro de que quieres cerrar sesión?')) {
                try {
                    const response = await fetch('/logout', {
                        method: 'POST',
                        credentials: 'include'
                    });

                    if (response.ok) {
                        window.location.href = '/login';
                    } else {
                        console.error('Logout error:', response.status);
                        alert('Error al cerrar sesión. Inténtalo de nuevo.');
                    }
                } catch (error) {
                    console.error('Logout connection error:', error);
                    alert('Error de conexión. Inténtalo de nuevo.');
                }
            }
        }

        // Error display function
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.innerHTML = `
                <i class="fas fa-exclamation-circle me-2"></i>
                ${message}
            `;

            const content = document.getElementById('content');
            content.insertBefore(errorDiv, content.firstChild);

            setTimeout(() => {
                errorDiv.remove();
            }, 5000);
        }

        // Close mobile menu when clicking outside
        document.addEventListener('click', function(e) {
            const menu = document.getElementById('mainMenu');
            const menuBtn = document.querySelector('.mobile-menu-btn');
            const content = document.getElementById('content');

            if (!menu.contains(e.target) && !menuBtn.contains(e.target) && menu.classList.contains('show')) {
                menu.classList.remove('show');
                content.classList.remove('mobile-menu-open');
            }
        });
    </script>
</body>
</html>
