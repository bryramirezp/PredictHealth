{% extends "base.html" %}

{% block title %}Dashboard - {{ cms_title }}{% endblock %}

{% block page_title %}Dashboard{% endblock %}

{% block page_subtitle %}Welcome back, {{ user_role_display }}! Here's an overview of your CMS activity.{% endblock %}

{% block extra_head %}
<style>
    /* Modern Healthcare Dashboard Styles */
    .kpi-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .kpi-card {
        background: white;
        border-radius: 16px;
        padding: 1.5rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        border: 1px solid #e5e7eb;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    .kpi-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 10px 25px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }

    .kpi-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, var(--primary-color), #3b82f6);
    }

    .kpi-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 1rem;
    }

    .kpi-title {
        font-size: 0.875rem;
        font-weight: 600;
        color: #6b7280;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin: 0;
    }

    .kpi-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.25rem;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .kpi-value {
        font-size: 2.5rem;
        font-weight: 800;
        color: #1f2937;
        margin: 0;
        line-height: 1;
    }

    .kpi-subtitle {
        font-size: 0.875rem;
        color: #6b7280;
        margin: 0.5rem 0 0 0;
    }

    /* Charts Section */
    .charts-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 2rem;
        margin-bottom: 2rem;
    }

    .chart-card {
        background: white;
        border-radius: 16px;
        padding: 2rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        border: 1px solid #e5e7eb;
    }

    .chart-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 1.5rem;
    }

    .chart-title {
        font-size: 1.25rem;
        font-weight: 700;
        color: #1f2937;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .chart-container {
        position: relative;
        height: 400px;
    }

    /* Analytics Grid */
    .analytics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 2rem;
        margin-bottom: 2rem;
    }

    .analytics-card {
        background: white;
        border-radius: 16px;
        padding: 1.5rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        border: 1px solid #e5e7eb;
    }

    .analytics-header {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 1rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid #f3f4f6;
    }

    .analytics-icon {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.125rem;
        background: var(--primary-color);
        color: white;
    }

    .analytics-title {
        font-size: 1.125rem;
        font-weight: 600;
        color: #1f2937;
        margin: 0;
    }

    .metric-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
    }

    .metric-item {
        text-align: center;
        padding: 1rem;
        background: #f8fafc;
        border-radius: 8px;
        border: 1px solid #e5e7eb;
    }

    .metric-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: #1f2937;
        margin: 0;
    }

    .metric-label {
        font-size: 0.875rem;
        color: #6b7280;
        margin: 0.25rem 0 0 0;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    /* Quick Actions */
    .quick-actions {
        background: white;
        border-radius: 16px;
        padding: 2rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        border: 1px solid #e5e7eb;
    }

    .actions-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
    }

    .action-card {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 1.25rem;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 12px;
        text-decoration: none;
        color: white;
        transition: all 0.3s ease;
        border: none;
    }

    .action-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px -8px rgba(102, 126, 234, 0.5);
        background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%);
    }

    .action-icon {
        width: 48px;
        height: 48px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.25rem;
        background: rgba(255, 255, 255, 0.2);
    }

    .action-content h4 {
        font-size: 1rem;
        font-weight: 600;
        margin: 0 0 0.25rem 0;
    }

    .action-content p {
        font-size: 0.875rem;
        margin: 0;
        opacity: 0.9;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        .kpi-grid {
            grid-template-columns: 1fr;
        }

        .analytics-grid {
            grid-template-columns: 1fr;
        }

        .actions-grid {
            grid-template-columns: 1fr;
        }

        .kpi-value {
            font-size: 2rem;
        }

        .chart-container {
            height: 300px;
        }
    }

    /* Loading states */
    .loading {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 200px;
        color: #6b7280;
    }

    .loading i {
        margin-right: 0.5rem;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block content %}
<!-- KPI Cards -->
<div class="kpi-grid">
    <div class="kpi-card">
        <div class="kpi-header">
            <h3 class="kpi-title">Total Doctors</h3>
            <div class="kpi-icon">
                <i class="bi bi-person-badge"></i>
            </div>
        </div>
        <p class="kpi-value">{{ dashboard_overview.total_doctors if dashboard_overview else 0 }}</p>
        <p class="kpi-subtitle">Healthcare providers</p>
    </div>

    <div class="kpi-card">
        <div class="kpi-header">
            <h3 class="kpi-title">Total Patients</h3>
            <div class="kpi-icon">
                <i class="bi bi-person-heart"></i>
            </div>
        </div>
        <p class="kpi-value">{{ dashboard_overview.total_patients if dashboard_overview else 0 }}</p>
        <p class="kpi-subtitle">Registered patients</p>
    </div>

    <div class="kpi-card">
        <div class="kpi-header">
            <h3 class="kpi-title">Total Institutions</h3>
            <div class="kpi-icon">
                <i class="bi bi-building"></i>
            </div>
        </div>
        <p class="kpi-value">{{ dashboard_overview.total_institutions if dashboard_overview else 0 }}</p>
        <p class="kpi-subtitle">Medical institutions</p>
    </div>
</div>

<!-- Charts Section -->
<div class="charts-grid">
    <div class="chart-card">
        <div class="chart-header">
            <h3 class="chart-title">
                <i class="bi bi-graph-up text-primary"></i>
                Monthly Patient Registrations
            </h3>
        </div>
        <div class="chart-container">
            <canvas id="registrationsChart"></canvas>
        </div>
    </div>
</div>

<!-- Analytics Grid -->
<div class="analytics-grid">
    <!-- Doctor Specialties -->
    <div class="analytics-card">
        <div class="analytics-header">
            <div class="analytics-icon">
                <i class="bi bi-person-hearts"></i>
            </div>
            <h3 class="analytics-title">Doctor Specialties</h3>
        </div>
        <div class="chart-container" style="height: 250px;">
            <canvas id="specialtiesChart"></canvas>
        </div>
    </div>

    <!-- Institutions by Type -->
    <div class="analytics-card">
        <div class="analytics-header">
            <div class="analytics-icon">
                <i class="bi bi-building"></i>
            </div>
            <h3 class="analytics-title">Institutions Overview</h3>
        </div>
        <div class="metric-grid">
            {% for geo in geographic_data[:4] %}
            <div class="metric-item">
                <p class="metric-value">{{ geo.institution_count }}</p>
                <p class="metric-label">{{ geo.region_state[:12] }}</p>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Health Conditions -->
    <div class="analytics-card">
        <div class="analytics-header">
            <div class="analytics-icon">
                <i class="bi bi-heart-pulse"></i>
            </div>
            <h3 class="analytics-title">Health Conditions</h3>
        </div>
        <div class="chart-container" style="height: 250px;">
            <canvas id="conditionsChart"></canvas>
        </div>
    </div>

    <!-- Patient Validation Status -->
    <div class="analytics-card">
        <div class="analytics-header">
            <div class="analytics-icon">
                <i class="bi bi-shield-check"></i>
            </div>
            <h3 class="analytics-title">Validation Status</h3>
        </div>
        <div class="chart-container" style="height: 250px;">
            <canvas id="validationChart"></canvas>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="quick-actions">
    <h3 class="chart-title mb-4">
        <i class="bi bi-lightning text-warning"></i>
        Quick Actions
    </h3>
    <div class="actions-grid">
        <a href="{{ url_for('entities.patients') }}" class="action-card">
            <div class="action-icon">
                <i class="bi bi-person-plus"></i>
            </div>
            <div class="action-content">
                <h4>Manage Patients</h4>
                <p>Add, edit, and view patient records</p>
            </div>
        </a>

        <a href="{{ url_for('entities.doctors') }}" class="action-card">
            <div class="action-icon">
                <i class="bi bi-person-badge"></i>
            </div>
            <div class="action-content">
                <h4>Manage Doctors</h4>
                <p>Healthcare provider management</p>
            </div>
        </a>

        <a href="{{ url_for('entities.institutions') }}" class="action-card">
            <div class="action-icon">
                <i class="bi bi-building"></i>
            </div>
            <div class="action-content">
                <h4>Manage Institutions</h4>
                <p>Healthcare facility administration</p>
            </div>
        </a>

        <a href="{{ url_for('reports.dashboard') }}" class="action-card">
            <div class="action-icon">
                <i class="bi bi-graph-up"></i>
            </div>
            <div class="action-content">
                <h4>View Reports</h4>
                <p>Advanced analytics and reporting</p>
            </div>
        </a>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Pass data from Jinja2 to JavaScript
const chartData = {
    months: {% if months_data %}{{ months_data|tojson }}{% else %}[]{% endif %},
    counts: {% if counts_data %}{{ counts_data|tojson }}{% else %}[]{% endif %},
    specialties: {% if specialty_data %}{{ specialty_data|tojson }}{% else %}[]{% endif %},
    conditions: {% if health_conditions %}{{ health_conditions|tojson }}{% else %}[]{% endif %},
    validation: {% if validation_status %}{{ validation_status|tojson }}{% else %}[]{% endif %}
};

// Healthcare Analytics Dashboard Charts
document.addEventListener('DOMContentLoaded', function() {
    // Monthly Registrations Chart
    const registrationsCtx = document.getElementById('registrationsChart');
    if (registrationsCtx && chartData.months.length > 0) {
        new Chart(registrationsCtx, {
            type: 'line',
            data: {
                labels: chartData.months,
                datasets: [{
                    label: 'Patient Registrations',
                    data: chartData.counts,
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4,
                    pointBackgroundColor: '#3b82f6',
                    pointBorderColor: '#ffffff',
                    pointBorderWidth: 2,
                    pointRadius: 6,
                    pointHoverRadius: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleColor: '#ffffff',
                        bodyColor: '#ffffff',
                        cornerRadius: 8,
                        displayColors: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: { color: 'rgba(0, 0, 0, 0.1)' },
                        ticks: { color: '#6b7280' }
                    },
                    x: {
                        grid: { color: 'rgba(0, 0, 0, 0.1)' },
                        ticks: { color: '#6b7280' }
                    }
                },
                interaction: { intersect: false, mode: 'index' }
            }
        });
    }

    // Doctor Specialties Chart
    const specialtiesCtx = document.getElementById('specialtiesChart');
    if (specialtiesCtx && chartData.specialties.length > 0) {
        new Chart(specialtiesCtx, {
            type: 'doughnut',
            data: {
                labels: chartData.specialties.map(item => item.specialty),
                datasets: [{
                    data: chartData.specialties.map(item => item.doctor_count),
                    backgroundColor: ['#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6', '#06b6d4', '#f97316', '#84cc16'],
                    borderWidth: 0,
                    hoverOffset: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom', labels: { padding: 20, usePointStyle: true, font: { size: 12 } } },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleColor: '#ffffff',
                        bodyColor: '#ffffff',
                        cornerRadius: 8,
                        callbacks: {
                            label: function(context) {
                                return context.label + ': ' + context.parsed + ' doctors';
                            }
                        }
                    }
                },
                cutout: '60%'
            }
        });
    }

    // Health Conditions Chart
    const conditionsCtx = document.getElementById('conditionsChart');
    if (conditionsCtx && chartData.conditions.length > 0) {
        new Chart(conditionsCtx, {
            type: 'bar',
            data: {
                labels: chartData.conditions.map(item => item.condition),
                datasets: [{
                    label: 'Patients',
                    data: chartData.conditions.map(item => item.patient_count),
                    backgroundColor: ['#ef4444', '#10b981', '#f59e0b'],
                    borderRadius: 8,
                    borderSkipped: false
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleColor: '#ffffff',
                        bodyColor: '#ffffff',
                        cornerRadius: 8,
                        callbacks: {
                            label: function(context) {
                                return context.parsed.y + ' patients';
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: { color: 'rgba(0, 0, 0, 0.1)' },
                        ticks: { color: '#6b7280' }
                    },
                    x: {
                        grid: { display: false },
                        ticks: { color: '#6b7280' }
                    }
                }
            }
        });
    }

    // Patient Validation Status Chart
    const validationCtx = document.getElementById('validationChart');
    if (validationCtx && chartData.validation.length > 0) {
        new Chart(validationCtx, {
            type: 'pie',
            data: {
                labels: chartData.validation.map(item => item.validation_status.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())),
                datasets: [{
                    data: chartData.validation.map(item => item.patient_count),
                    backgroundColor: ['#ef4444', '#f59e0b', '#3b82f6', '#10b981'],
                    borderWidth: 0,
                    hoverOffset: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom', labels: { padding: 15, usePointStyle: true, font: { size: 12 } } },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleColor: '#ffffff',
                        bodyColor: '#ffffff',
                        cornerRadius: 8,
                        callbacks: {
                            label: function(context) {
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((context.parsed / total) * 100).toFixed(1);
                                return context.label + ': ' + context.parsed + ' (' + percentage + '%)';
                            }
                        }
                    }
                }
            }
        });
    }
});

// Auto-refresh dashboard data every 5 minutes
setInterval(function() {
    console.log('Healthcare dashboard auto-refresh would happen here');
}, 300000);
</script>
{% endblock %}