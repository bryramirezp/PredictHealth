version: "3.9"

services:

  # Base de datos PostgreSQL
  postgres:
    build:
      context: .
      dockerfile: database/postgresql/Dockerfile
    container_name: predicthealth-postgres
    environment:
      POSTGRES_DB: predicthealth_db
      POSTGRES_USER: predictHealth_user
      POSTGRES_PASSWORD: password
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./populate.sql:/docker-entrypoint-initdb.d/populate.sql
    networks:
      - predicthealth-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U predictHealth_user -d predicthealth_db"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Redis para caché y sesiones
  redis:
    build:
      context: ./database/redis
      dockerfile: Dockerfile
    container_name: predicthealth-redis
    volumes:
      - redis_data:/data
    networks:
      - predicthealth-network
    restart: unless-stopped
    ports: ["6379:6379"]
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Auth-JWT Service (Authentication & JWT Token Management)
  servicio-auth-jwt:
    build:
      context: .
      dockerfile: microservices/auth-jwt-service/Dockerfile
    container_name: predicthealth-auth-jwt
    env_file:
      - microservices/auth-jwt-service/.env
    ports:
      - "8003:8003"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - predicthealth-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8003/health"]
      interval: 30s
      timeout: 10s
      retries: 5

  # Servicio de Doctores
  servicio-doctores:
    build:
      context: .
      dockerfile: microservices/service-doctors/Dockerfile
    container_name: predicthealth-doctores
    env_file:
      - microservices/service-doctors/.env
    ports:
      - "8000:8000"
    depends_on:
      postgres:
        condition: service_healthy
      servicio-auth-jwt:
        condition: service_healthy
    networks:
      - predicthealth-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Servicio de Pacientes
  servicio-pacientes:
    build:
      context: .
      dockerfile: microservices/service-patients/Dockerfile
    container_name: predicthealth-pacientes
    env_file:
      - microservices/service-patients/.env
    ports:
      - "8004:8004"
    depends_on:
      postgres:
        condition: service_healthy
      servicio-auth-jwt:
        condition: service_healthy
    networks:
      - predicthealth-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8004/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Servicio de Instituciones
  servicio-instituciones:
    build:
      context: .
      dockerfile: microservices/service-institutions/Dockerfile
    container_name: predicthealth-instituciones
    env_file:
      - microservices/service-institutions/.env
    ports:
      - "8002:8002"
    depends_on:
      postgres:
        condition: service_healthy
      servicio-auth-jwt:
        condition: service_healthy
    networks:
      - predicthealth-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8002/health"]
      interval: 30s
      timeout: 10s
      retries: 3


  # Backend Flask (API Gateway)
  backend-flask:
    build:
      context: .
      dockerfile: backend-flask/Dockerfile
    container_name: predicthealth-backend
    env_file:
      - backend-flask/.env
    ports:
      - "5000:5000"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      servicio-auth-jwt:
        condition: service_healthy
      servicio-doctores:
        condition: service_healthy
      servicio-pacientes:
        condition: service_healthy
      servicio-instituciones:
        condition: service_healthy
    networks:
      - predicthealth-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # CMS Backend (Content Management System)
  cms-backend:
    build:
      context: ./cms-backend
      dockerfile: Dockerfile
    container_name: predicthealth-cms
    env_file:
      - cms-backend/.env
    ports:
      - "5001:5001"
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      - DOCKER_HOST=tcp://host.docker.internal:2375    # Connect to Docker Desktop TCP endpoint (puerto 2375 como habilitaste)
      - DOCKER_TLS_VERIFY=0                            # Disable TLS verification for Docker Desktop
    networks:
      - predicthealth-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5001/health"]
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local

networks:
  predicthealth-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

# Comandos rápidos para acceder a PostgreSQL:
# - Desde el host (si tienes psql instalado):
#   psql -h localhost -p 5432 -U predictHealth_user -d predicthealth_db
#   (te pedirá la contraseña: password)
# - Entrar al contenedor directamente:
#   docker exec -it predicthealth-postgres psql -U predictHealth_user -d predicthealth_db
# - Usando docker-compose (desde la carpeta del proyecto):
#   docker-compose -f e:\PredictHealth\PredictHealth\docker-compose.yml exec postgres psql -U predictHealth_user -d predicthealth_db
